iptables -F
iptables -t nat -F
iptables -t mangle -F

# COMIENZO DEL FIREWALL PERSONALIZADO
iptables -A FORWARD -d 200.69.248.13 -j ACCEPT
iptables -A FORWARD -s 200.69.248.13 -j ACCEPT
iptables -A FORWARD -s 190.221.46.236 -j ACCEPT
iptables -A FORWARD -d 190.221.46.236 -j ACCEPT
iptables -A FORWARD -d 190.221.46.236 -j ACCEPT
iptables -A FORWARD -d 200.80.194.18 -p udp -j ACCEPT
iptables -A FORWARD -s 200.80.194.18 -p udp -j ACCEPT
iptables -A FORWARD -d 200.80.194.18 -p tcp -j ACCEPT
iptables -A FORWARD -s 200.80.194.18 -p tcp -j ACCEPT
iptables -A FORWARD -d 200.80.195.18 -p udp -j ACCEPT
iptables -A FORWARD -s 200.80.195.18 -p udp -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 3128 -j ACCEPT
iptables -A INPUT -i eth0 -p tcp --dport 3128 -j ACCEPT
iptables -A FORWARD -d 190.2.45.229 -j ACCEPT
iptables -A FORWARD -s 190.2.45.229 -j ACCEPT
iptables -A FORWARD -d 190.2.29.89 -j ACCEPT
iptables -A FORWARD -s 190.2.29.89 -j ACCEPT

# FIN DEL FIREWALL PERSONALIZADO

# COMIENZO DE FILTROS PERSONALIZADOS

# FIN DE FILTROS PERSONALIZADO

# COMIENZO DE FIREWALL ESTANDAR
iptables -P INPUT ACCEPT
iptables -P OUTPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -A FORWARD -o tun+ -j ACCEPT
iptables -A FORWARD -i tun+ -j ACCEPT
iptables -A OUTPUT -o tun+ -j ACCEPT
iptables -A INPUT -i tun+ -j ACCEPT
iptables -t nat -A POSTROUTING -o tun+ -j MASQUERADE
iptables -A INPUT -p 50 -j ACCEPT
iptables -A OUTPUT -p 51 -j ACCEPT
iptables -A INPUT -p 51 -j ACCEPT
iptables -A OUTPUT -p 50 -j ACCEPT
iptables -A INPUT -p udp --sport 1194 -j ACCEPT
iptables -A OUTPUT -p udp --dport 1194 -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
iptables -A OUTPUT -p tcp --sport 22 -j ACCEPT
iptables -A INPUT -p tcp --sport 22 -j ACCEPT
iptables -A OUTPUT -p tcp --dport 22 -j ACCEPT
iptables -X 80in
iptables -N 80in
iptables -A 80in
iptables -X 80out
iptables -N 80out
iptables -A 80out
iptables -A FORWARD -s 172.16.0.0/24 -p tcp --dport 80 -j 80out
iptables -A FORWARD -d 172.16.0.0/24 -p tcp --sport 80 -j 80in
iptables -X 110in
iptables -N 110in
iptables -A 110in
iptables -X 110out
iptables -N 110out
iptables -A 110out
iptables -A FORWARD -s 172.16.0.0/24 -p tcp --dport 110 -j 110out
iptables -A FORWARD -d 172.16.0.0/24 -p tcp --sport 110 -j 110in
iptables -X 21in
iptables -N 21in
iptables -A 21in
iptables -X 21out
iptables -N 21out
iptables -A 21out
iptables -A FORWARD -s 172.16.0.0/24 -p tcp --dport 21 -j 21out
iptables -A FORWARD -d 172.16.0.0/24 -p tcp --sport 21 -j 21in
iptables -X 25in
iptables -N 25in
iptables -A 25in
iptables -X 25out
iptables -N 25out
iptables -A 25out
iptables -A FORWARD -s 172.16.0.0/24 -p tcp --dport 25 -j 25out
iptables -A FORWARD -d 172.16.0.0/24 -p tcp --sport 25 -j 25in
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT
iptables -A INPUT -p ICMP -j ACCEPT
iptables -A OUTPUT -p ICMP -j ACCEPT
iptables -A INPUT -p tcp --dport 2801 -j ACCEPT
iptables -A OUTPUT -p tcp --sport 2801 -j ACCEPT
iptables -A INPUT -p tcp --sport 43 -j ACCEPT
iptables -A OUTPUT -p tcp --dport 43 -j ACCEPT
iptables -A INPUT -p tcp --dport 2801 -j ACCEPT
iptables -A OUTPUT -p tcp --sport 2801 -j ACCEPT
iptables -A INPUT -p udp --sport 53 -j ACCEPT
iptables -A OUTPUT -p udp --dport 53 -j ACCEPT
iptables -A INPUT -i eth0 -p udp --dport 53 -j ACCEPT
iptables -A OUTPUT -o eth0 -p udp --sport 53 -j ACCEPT
iptables -A INPUT -i eth1 -p udp --sport 53 -j ACCEPT
iptables -A OUTPUT -o eth1 -p udp --dport 53 -j ACCEPT
iptables -A INPUT -p udp --dport 500 -j ACCEPT
iptables -A OUTPUT -p udp --dport 500 -j ACCEPT
iptables -A INPUT -p tcp --sport 80 -j ACCEPT
iptables -A OUTPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A OUTPUT -p tcp --sport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 1723 -j ACCEPT
iptables -A OUTPUT -p tcp --sport 1723 -j ACCEPT
iptables -A INPUT -p 47 -j ACCEPT
iptables -A OUTPUT -p 47 -j ACCEPT
iptables -A INPUT -p udp --sport 67:68 --dport 67:68 -j ACCEPT
iptables -A OUTPUT -p udp --dport 67:68 --sport 67:68 -j ACCEPT
iptables -A INPUT -i eth0 -p tcp --dport 3128 -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 3128 -j ACCEPT
iptables -A FORWARD -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
iptables -X syn-flood
iptables -N syn-flood
iptables -A INPUT -i eth1 -p tcp --syn -j syn-flood
iptables -A INPUT -i eth0 -p tcp --syn -j syn-flood
iptables -A syn-flood -m limit --limit 1/s --limit-burst 4 -j RETURN
iptables -A syn-flood -j DROP
iptables -A INPUT -i eth1 -f -j LOG --log-prefix 'Fragmento! '
iptables -A INPUT -i eth1 -f -j DROP
iptables -A INPUT -i eth0 -f -j LOG --log-prefix 'Fragmento! '
iptables -A INPUT -i eth0 -f -j DROP
iptables -t mangle -A PREROUTING -p icmp -j TOS --set-tos Minimize-Delay
echo 1 > /proc/sys/net/ipv4/icmp_echo_ignore_broadcasts
echo 0 > /proc/sys/net/ipv4/conf/all/accept_redirects
echo 0 > /proc/sys/net/ipv4/conf/all/log_martians
iptables -X ICMP
iptables -N ICMP
iptables -A ICMP -i eth1 -s 0.0.0.0/0 -p icmp -j LOG --log-level info --log-prefix 'ICMP FILTRADOS INTERNET:   '
iptables -A ICMP -i eth0 -s 0.0.0.0/0 -p icmp -j LOG --log-level info --log-prefix 'ICMP FILTRADOS LAN:   '

# FIN DE FIREWALL ESTANDAR

# FIREWALL PARA DNSS
#===========================================================================
iptables -t nat -A POSTROUTING -o eth1 -d 172.16.0.1 -p udp --dport 53 -j MASQUERADE
iptables -A FORWARD -i eth0 -d 172.16.0.1 -p udp --dport 53 -j ACCEPT
# FIN de FIREWALL PARA DNSS
#===========================================================================
#Definicion de las colas basicas
#===========================================================================


tc qdisc del dev eth0 root
tc qdisc add dev eth0 root handle 1: htb
tc qdisc del dev eth1 root
tc qdisc add dev eth1 root handle 1: htb


#------------------------------------------------------------------------------
#Cliente - PC 7	IP:107    ID: 3
#------------------------------------------------------------------------------
iptables -X 172.16.0.107_i
iptables -X 172.16.0.107_o
iptables -N 172.16.0.107_i
iptables -N 172.16.0.107_o
iptables -F 172.16.0.107_i
iptables -F 172.16.0.107_o
iptables -A FORWARD -s 172.16.0.107 -j 172.16.0.107_o
iptables -A FORWARD -d 172.16.0.107 -j 172.16.0.107_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:31 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:31 classid 1:3a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:31 classid 1:3b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 301 fw classid 1:3a
tc filter add dev eth0 protocol ip parent 1: handle 302 fw classid 1:3b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:30 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:30 classid 1:3d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:30 classid 1:3e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 304 fw classid 1:3d
tc filter add dev eth1 protocol ip parent 1: handle 305 fw classid 1:3e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.107 --set-mark 302
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.107 --set-mark 305

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.107 -p tcp --dport 22 --set-mark 304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.107 -p tcp --sport 22 --set-mark 301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.107 -p udp --dport 53 --set-mark 304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.107 -p udp --sport 53 --set-mark 301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.107 -p tcp --dport 80 --set-mark 304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.107 -p tcp --sport 80 --set-mark 301
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.107 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.107 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Asterisk	IP:2    ID: 77
#------------------------------------------------------------------------------
iptables -X 172.16.0.2_i
iptables -X 172.16.0.2_o
iptables -N 172.16.0.2_i
iptables -N 172.16.0.2_o
iptables -F 172.16.0.2_i
iptables -F 172.16.0.2_o
iptables -A FORWARD -s 172.16.0.2 -j 172.16.0.2_o
iptables -A FORWARD -d 172.16.0.2 -j 172.16.0.2_i
iptables -A FORWARD -s 172.16.0.2 -m mac --mac-source 70:71:bc:71:98:2a -j ACCEPT
iptables -A FORWARD -d 172.16.0.2 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:771 htb rate 2048kbit ceil 2048kbit burst 15k
tc class add dev eth0 parent 1:771 classid 1:77a htb rate 819kbit ceil 2048kbit burst 15k prio 0
tc class add dev eth0 parent 1:771 classid 1:77b htb rate 819kbit ceil 2048kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 7701 fw classid 1:77a
tc filter add dev eth0 protocol ip parent 1: handle 7702 fw classid 1:77b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:770 htb rate 2048kbit ceil 2048kbit burst 15k
tc class add dev eth1 parent 1:770 classid 1:77d htb rate 819kbit ceil 2048kbit burst 15k prio 0
tc class add dev eth1 parent 1:770 classid 1:77e htb rate 819kbit ceil 2048kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 7704 fw classid 1:77d
tc filter add dev eth1 protocol ip parent 1: handle 7705 fw classid 1:77e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.2 --set-mark 7702
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.2 --set-mark 7705

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.2 -p tcp --dport 22 --set-mark 7704
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.2 -p tcp --sport 22 --set-mark 7701
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.2 -p udp --dport 53 --set-mark 7704
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.2 -p udp --sport 53 --set-mark 7701
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.2 -p tcp --dport 80 --set-mark 7704
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.2 -p tcp --sport 80 --set-mark 7701
iptables -t nat -A POSTROUTING -s 172.16.0.2 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC 5	IP:105    ID: 116
#------------------------------------------------------------------------------
iptables -X 172.16.0.105_i
iptables -X 172.16.0.105_o
iptables -N 172.16.0.105_i
iptables -N 172.16.0.105_o
iptables -F 172.16.0.105_i
iptables -F 172.16.0.105_o
iptables -A FORWARD -s 172.16.0.105 -j 172.16.0.105_o
iptables -A FORWARD -d 172.16.0.105 -j 172.16.0.105_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:1161 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:1161 classid 1:116a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:1161 classid 1:116b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 11601 fw classid 1:116a
tc filter add dev eth0 protocol ip parent 1: handle 11602 fw classid 1:116b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:1160 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:1160 classid 1:116d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:1160 classid 1:116e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 11604 fw classid 1:116d
tc filter add dev eth1 protocol ip parent 1: handle 11605 fw classid 1:116e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.105 --set-mark 11602
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.105 --set-mark 11605

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.105 -p tcp --dport 22 --set-mark 11604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.105 -p tcp --sport 22 --set-mark 11601
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.105 -p udp --dport 53 --set-mark 11604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.105 -p udp --sport 53 --set-mark 11601
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.105 -p tcp --dport 80 --set-mark 11604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.105 -p tcp --sport 80 --set-mark 11601
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.105 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.105 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC 8	IP:108    ID: 123
#------------------------------------------------------------------------------
iptables -X 172.16.0.108_i
iptables -X 172.16.0.108_o
iptables -N 172.16.0.108_i
iptables -N 172.16.0.108_o
iptables -F 172.16.0.108_i
iptables -F 172.16.0.108_o
iptables -A FORWARD -s 172.16.0.108 -j 172.16.0.108_o
iptables -A FORWARD -d 172.16.0.108 -j 172.16.0.108_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:1231 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:1231 classid 1:123a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:1231 classid 1:123b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 12301 fw classid 1:123a
tc filter add dev eth0 protocol ip parent 1: handle 12302 fw classid 1:123b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:1230 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:1230 classid 1:123d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:1230 classid 1:123e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 12304 fw classid 1:123d
tc filter add dev eth1 protocol ip parent 1: handle 12305 fw classid 1:123e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.108 --set-mark 12302
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.108 --set-mark 12305

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.108 -p tcp --dport 22 --set-mark 12304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.108 -p tcp --sport 22 --set-mark 12301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.108 -p udp --dport 53 --set-mark 12304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.108 -p udp --sport 53 --set-mark 12301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.108 -p tcp --dport 80 --set-mark 12304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.108 -p tcp --sport 80 --set-mark 12301
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.108 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.108 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC 3	IP:103    ID: 124
#------------------------------------------------------------------------------
iptables -X 172.16.0.103_i
iptables -X 172.16.0.103_o
iptables -N 172.16.0.103_i
iptables -N 172.16.0.103_o
iptables -F 172.16.0.103_i
iptables -F 172.16.0.103_o
iptables -A FORWARD -s 172.16.0.103 -j 172.16.0.103_o
iptables -A FORWARD -d 172.16.0.103 -j 172.16.0.103_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:1241 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:1241 classid 1:124a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:1241 classid 1:124b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 12401 fw classid 1:124a
tc filter add dev eth0 protocol ip parent 1: handle 12402 fw classid 1:124b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:1240 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:1240 classid 1:124d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:1240 classid 1:124e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 12404 fw classid 1:124d
tc filter add dev eth1 protocol ip parent 1: handle 12405 fw classid 1:124e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.103 --set-mark 12402
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.103 --set-mark 12405

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.103 -p tcp --dport 22 --set-mark 12404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.103 -p tcp --sport 22 --set-mark 12401
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.103 -p udp --dport 53 --set-mark 12404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.103 -p udp --sport 53 --set-mark 12401
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.103 -p tcp --dport 80 --set-mark 12404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.103 -p tcp --sport 80 --set-mark 12401
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.103 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.103 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Backup	IP:71    ID: 133
#------------------------------------------------------------------------------
iptables -X 172.16.0.71_i
iptables -X 172.16.0.71_o
iptables -N 172.16.0.71_i
iptables -N 172.16.0.71_o
iptables -F 172.16.0.71_i
iptables -F 172.16.0.71_o
iptables -A FORWARD -s 172.16.0.71 -j 172.16.0.71_o
iptables -A FORWARD -d 172.16.0.71 -j 172.16.0.71_i
iptables -A FORWARD -s 172.16.0.71 -m mac --mac-source 00:27:0e:16:27:b3 -j ACCEPT
iptables -A FORWARD -d 172.16.0.71 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:1331 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:1331 classid 1:133a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:1331 classid 1:133b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 13301 fw classid 1:133a
tc filter add dev eth0 protocol ip parent 1: handle 13302 fw classid 1:133b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:1330 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:1330 classid 1:133d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:1330 classid 1:133e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 13304 fw classid 1:133d
tc filter add dev eth1 protocol ip parent 1: handle 13305 fw classid 1:133e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.71 --set-mark 13302
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.71 --set-mark 13305

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.71 -p tcp --dport 22 --set-mark 13304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.71 -p tcp --sport 22 --set-mark 13301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.71 -p udp --dport 53 --set-mark 13304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.71 -p udp --sport 53 --set-mark 13301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.71 -p tcp --dport 80 --set-mark 13304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.71 -p tcp --sport 80 --set-mark 13301
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.71 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.71 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC12	IP:112    ID: 136
#------------------------------------------------------------------------------
iptables -X 172.16.0.112_i
iptables -X 172.16.0.112_o
iptables -N 172.16.0.112_i
iptables -N 172.16.0.112_o
iptables -F 172.16.0.112_i
iptables -F 172.16.0.112_o
iptables -A FORWARD -s 172.16.0.112 -j 172.16.0.112_o
iptables -A FORWARD -d 172.16.0.112 -j 172.16.0.112_i
iptables -A FORWARD -s 172.16.0.112 -m mac --mac-source 00:0B:6A:BF:94:26 -j ACCEPT
iptables -A FORWARD -d 172.16.0.112 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:1361 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:1361 classid 1:136a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:1361 classid 1:136b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 13601 fw classid 1:136a
tc filter add dev eth0 protocol ip parent 1: handle 13602 fw classid 1:136b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:1360 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:1360 classid 1:136d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:1360 classid 1:136e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 13604 fw classid 1:136d
tc filter add dev eth1 protocol ip parent 1: handle 13605 fw classid 1:136e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.112 --set-mark 13602
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.112 --set-mark 13605

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.112 -p tcp --dport 22 --set-mark 13604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.112 -p tcp --sport 22 --set-mark 13601
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.112 -p udp --dport 53 --set-mark 13604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.112 -p udp --sport 53 --set-mark 13601
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.112 -p tcp --dport 80 --set-mark 13604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.112 -p tcp --sport 80 --set-mark 13601
iptables -t nat -A POSTROUTING -s 172.16.0.112 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Carlos Rodriguez	IP:56    ID: 138
#------------------------------------------------------------------------------
iptables -X 172.16.0.56_i
iptables -X 172.16.0.56_o
iptables -N 172.16.0.56_i
iptables -N 172.16.0.56_o
iptables -F 172.16.0.56_i
iptables -F 172.16.0.56_o
iptables -A FORWARD -s 172.16.0.56 -j 172.16.0.56_o
iptables -A FORWARD -d 172.16.0.56 -j 172.16.0.56_i
iptables -A FORWARD -s 172.16.0.56 -m mac --mac-source 00:27:0E:16:AC:39 -j ACCEPT
iptables -A FORWARD -d 172.16.0.56 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:1381 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:1381 classid 1:138a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:1381 classid 1:138b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 13801 fw classid 1:138a
tc filter add dev eth0 protocol ip parent 1: handle 13802 fw classid 1:138b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:1380 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:1380 classid 1:138d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:1380 classid 1:138e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 13804 fw classid 1:138d
tc filter add dev eth1 protocol ip parent 1: handle 13805 fw classid 1:138e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.56 --set-mark 13802
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.56 --set-mark 13805

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.56 -p tcp --dport 22 --set-mark 13804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.56 -p tcp --sport 22 --set-mark 13801
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.56 -p udp --dport 53 --set-mark 13804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.56 -p udp --sport 53 --set-mark 13801
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.56 -p tcp --dport 80 --set-mark 13804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.56 -p tcp --sport 80 --set-mark 13801
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.56 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.56 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC 4	IP:104    ID: 141
#------------------------------------------------------------------------------
iptables -X 172.16.0.104_i
iptables -X 172.16.0.104_o
iptables -N 172.16.0.104_i
iptables -N 172.16.0.104_o
iptables -F 172.16.0.104_i
iptables -F 172.16.0.104_o
iptables -A FORWARD -s 172.16.0.104 -j 172.16.0.104_o
iptables -A FORWARD -d 172.16.0.104 -j 172.16.0.104_i
iptables -A FORWARD -s 172.16.0.104 -m mac --mac-source 00:0B:6A:C6:5E:8F -j ACCEPT
iptables -A FORWARD -d 172.16.0.104 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:1411 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:1411 classid 1:141a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:1411 classid 1:141b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 14101 fw classid 1:141a
tc filter add dev eth0 protocol ip parent 1: handle 14102 fw classid 1:141b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:1410 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:1410 classid 1:141d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:1410 classid 1:141e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 14104 fw classid 1:141d
tc filter add dev eth1 protocol ip parent 1: handle 14105 fw classid 1:141e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.104 --set-mark 14102
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.104 --set-mark 14105

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.104 -p tcp --dport 22 --set-mark 14104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.104 -p tcp --sport 22 --set-mark 14101
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.104 -p udp --dport 53 --set-mark 14104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.104 -p udp --sport 53 --set-mark 14101
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.104 -p tcp --dport 80 --set-mark 14104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.104 -p tcp --sport 80 --set-mark 14101
iptables -t nat -A POSTROUTING -s 172.16.0.104 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC15	IP:115    ID: 153
#------------------------------------------------------------------------------
iptables -X 172.16.0.115_i
iptables -X 172.16.0.115_o
iptables -N 172.16.0.115_i
iptables -N 172.16.0.115_o
iptables -F 172.16.0.115_i
iptables -F 172.16.0.115_o
iptables -A FORWARD -s 172.16.0.115 -j 172.16.0.115_o
iptables -A FORWARD -d 172.16.0.115 -j 172.16.0.115_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:1531 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:1531 classid 1:153a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:1531 classid 1:153b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 15301 fw classid 1:153a
tc filter add dev eth0 protocol ip parent 1: handle 15302 fw classid 1:153b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:1530 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:1530 classid 1:153d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:1530 classid 1:153e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 15304 fw classid 1:153d
tc filter add dev eth1 protocol ip parent 1: handle 15305 fw classid 1:153e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.115 --set-mark 15302
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.115 --set-mark 15305

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.115 -p tcp --dport 22 --set-mark 15304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.115 -p tcp --sport 22 --set-mark 15301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.115 -p udp --dport 53 --set-mark 15304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.115 -p udp --sport 53 --set-mark 15301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.115 -p tcp --dport 80 --set-mark 15304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.115 -p tcp --sport 80 --set-mark 15301
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.115 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.115 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC14	IP:114    ID: 156
#------------------------------------------------------------------------------
iptables -X 172.16.0.114_i
iptables -X 172.16.0.114_o
iptables -N 172.16.0.114_i
iptables -N 172.16.0.114_o
iptables -F 172.16.0.114_i
iptables -F 172.16.0.114_o
iptables -A FORWARD -s 172.16.0.114 -j 172.16.0.114_o
iptables -A FORWARD -d 172.16.0.114 -j 172.16.0.114_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:1561 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:1561 classid 1:156a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:1561 classid 1:156b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 15601 fw classid 1:156a
tc filter add dev eth0 protocol ip parent 1: handle 15602 fw classid 1:156b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:1560 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:1560 classid 1:156d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:1560 classid 1:156e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 15604 fw classid 1:156d
tc filter add dev eth1 protocol ip parent 1: handle 15605 fw classid 1:156e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.114 --set-mark 15602
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.114 --set-mark 15605

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.114 -p tcp --dport 22 --set-mark 15604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.114 -p tcp --sport 22 --set-mark 15601
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.114 -p udp --dport 53 --set-mark 15604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.114 -p udp --sport 53 --set-mark 15601
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.114 -p tcp --dport 80 --set-mark 15604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.114 -p tcp --sport 80 --set-mark 15601
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.114 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.114 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC 9	IP:109    ID: 159
#------------------------------------------------------------------------------
iptables -X 172.16.0.109_i
iptables -X 172.16.0.109_o
iptables -N 172.16.0.109_i
iptables -N 172.16.0.109_o
iptables -F 172.16.0.109_i
iptables -F 172.16.0.109_o
iptables -A FORWARD -s 172.16.0.109 -j 172.16.0.109_o
iptables -A FORWARD -d 172.16.0.109 -j 172.16.0.109_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:1591 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:1591 classid 1:159a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:1591 classid 1:159b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 15901 fw classid 1:159a
tc filter add dev eth0 protocol ip parent 1: handle 15902 fw classid 1:159b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:1590 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:1590 classid 1:159d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:1590 classid 1:159e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 15904 fw classid 1:159d
tc filter add dev eth1 protocol ip parent 1: handle 15905 fw classid 1:159e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.109 --set-mark 15902
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.109 --set-mark 15905

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.109 -p tcp --dport 22 --set-mark 15904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.109 -p tcp --sport 22 --set-mark 15901
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.109 -p udp --dport 53 --set-mark 15904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.109 -p udp --sport 53 --set-mark 15901
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.109 -p tcp --dport 80 --set-mark 15904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.109 -p tcp --sport 80 --set-mark 15901
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.109 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.109 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Backup 1	IP:10    ID: 160
#------------------------------------------------------------------------------
iptables -X 172.16.0.10_i
iptables -X 172.16.0.10_o
iptables -N 172.16.0.10_i
iptables -N 172.16.0.10_o
iptables -F 172.16.0.10_i
iptables -F 172.16.0.10_o
iptables -A FORWARD -s 172.16.0.10 -j 172.16.0.10_o
iptables -A FORWARD -d 172.16.0.10 -j 172.16.0.10_i
iptables -A FORWARD -s 172.16.0.10 -m mac --mac-source 00:1C:C0:B1:3B:F3 -j ACCEPT
iptables -A FORWARD -d 172.16.0.10 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:1601 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:1601 classid 1:160a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:1601 classid 1:160b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 16001 fw classid 1:160a
tc filter add dev eth0 protocol ip parent 1: handle 16002 fw classid 1:160b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:1600 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:1600 classid 1:160d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:1600 classid 1:160e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 16004 fw classid 1:160d
tc filter add dev eth1 protocol ip parent 1: handle 16005 fw classid 1:160e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.10 --set-mark 16002
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.10 --set-mark 16005

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.10 -p tcp --dport 22 --set-mark 16004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.10 -p tcp --sport 22 --set-mark 16001
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.10 -p udp --dport 53 --set-mark 16004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.10 -p udp --sport 53 --set-mark 16001
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.10 -p tcp --dport 80 --set-mark 16004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.10 -p tcp --sport 80 --set-mark 16001
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.10 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.10 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC13	IP:113    ID: 161
#------------------------------------------------------------------------------
iptables -X 172.16.0.113_i
iptables -X 172.16.0.113_o
iptables -N 172.16.0.113_i
iptables -N 172.16.0.113_o
iptables -F 172.16.0.113_i
iptables -F 172.16.0.113_o
iptables -A FORWARD -s 172.16.0.113 -j 172.16.0.113_o
iptables -A FORWARD -d 172.16.0.113 -j 172.16.0.113_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:1611 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:1611 classid 1:161a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:1611 classid 1:161b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 16101 fw classid 1:161a
tc filter add dev eth0 protocol ip parent 1: handle 16102 fw classid 1:161b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:1610 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:1610 classid 1:161d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:1610 classid 1:161e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 16104 fw classid 1:161d
tc filter add dev eth1 protocol ip parent 1: handle 16105 fw classid 1:161e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.113 --set-mark 16102
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.113 --set-mark 16105

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.113 -p tcp --dport 22 --set-mark 16104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.113 -p tcp --sport 22 --set-mark 16101
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.113 -p udp --dport 53 --set-mark 16104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.113 -p udp --sport 53 --set-mark 16101
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.113 -p tcp --dport 80 --set-mark 16104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.113 -p tcp --sport 80 --set-mark 16101
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.113 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.113 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC16	IP:116    ID: 164
#------------------------------------------------------------------------------
iptables -X 172.16.0.116_i
iptables -X 172.16.0.116_o
iptables -N 172.16.0.116_i
iptables -N 172.16.0.116_o
iptables -F 172.16.0.116_i
iptables -F 172.16.0.116_o
iptables -A FORWARD -s 172.16.0.116 -j 172.16.0.116_o
iptables -A FORWARD -d 172.16.0.116 -j 172.16.0.116_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:1641 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:1641 classid 1:164a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:1641 classid 1:164b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 16401 fw classid 1:164a
tc filter add dev eth0 protocol ip parent 1: handle 16402 fw classid 1:164b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:1640 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:1640 classid 1:164d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:1640 classid 1:164e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 16404 fw classid 1:164d
tc filter add dev eth1 protocol ip parent 1: handle 16405 fw classid 1:164e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.116 --set-mark 16402
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.116 --set-mark 16405

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.116 -p tcp --dport 22 --set-mark 16404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.116 -p tcp --sport 22 --set-mark 16401
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.116 -p udp --dport 53 --set-mark 16404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.116 -p udp --sport 53 --set-mark 16401
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.116 -p tcp --dport 80 --set-mark 16404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.116 -p tcp --sport 80 --set-mark 16401
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.116 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.116 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC17	IP:117    ID: 167
#------------------------------------------------------------------------------
iptables -X 172.16.0.117_i
iptables -X 172.16.0.117_o
iptables -N 172.16.0.117_i
iptables -N 172.16.0.117_o
iptables -F 172.16.0.117_i
iptables -F 172.16.0.117_o
iptables -A FORWARD -s 172.16.0.117 -j 172.16.0.117_o
iptables -A FORWARD -d 172.16.0.117 -j 172.16.0.117_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:1671 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:1671 classid 1:167a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:1671 classid 1:167b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 16701 fw classid 1:167a
tc filter add dev eth0 protocol ip parent 1: handle 16702 fw classid 1:167b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:1670 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:1670 classid 1:167d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:1670 classid 1:167e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 16704 fw classid 1:167d
tc filter add dev eth1 protocol ip parent 1: handle 16705 fw classid 1:167e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.117 --set-mark 16702
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.117 --set-mark 16705

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.117 -p tcp --dport 22 --set-mark 16704
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.117 -p tcp --sport 22 --set-mark 16701
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.117 -p udp --dport 53 --set-mark 16704
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.117 -p udp --sport 53 --set-mark 16701
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.117 -p tcp --dport 80 --set-mark 16704
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.117 -p tcp --sport 80 --set-mark 16701
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.117 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.117 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC 2	IP:102    ID: 168
#------------------------------------------------------------------------------
iptables -X 172.16.0.102_i
iptables -X 172.16.0.102_o
iptables -N 172.16.0.102_i
iptables -N 172.16.0.102_o
iptables -F 172.16.0.102_i
iptables -F 172.16.0.102_o
iptables -A FORWARD -s 172.16.0.102 -j 172.16.0.102_o
iptables -A FORWARD -d 172.16.0.102 -j 172.16.0.102_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:1681 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:1681 classid 1:168a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:1681 classid 1:168b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 16801 fw classid 1:168a
tc filter add dev eth0 protocol ip parent 1: handle 16802 fw classid 1:168b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:1680 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:1680 classid 1:168d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:1680 classid 1:168e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 16804 fw classid 1:168d
tc filter add dev eth1 protocol ip parent 1: handle 16805 fw classid 1:168e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.102 --set-mark 16802
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.102 --set-mark 16805

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.102 -p tcp --dport 22 --set-mark 16804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.102 -p tcp --sport 22 --set-mark 16801
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.102 -p udp --dport 53 --set-mark 16804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.102 -p udp --sport 53 --set-mark 16801
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.102 -p tcp --dport 80 --set-mark 16804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.102 -p tcp --sport 80 --set-mark 16801
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.102 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.102 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC 6	IP:106    ID: 169
#------------------------------------------------------------------------------
iptables -X 172.16.0.106_i
iptables -X 172.16.0.106_o
iptables -N 172.16.0.106_i
iptables -N 172.16.0.106_o
iptables -F 172.16.0.106_i
iptables -F 172.16.0.106_o
iptables -A FORWARD -s 172.16.0.106 -j 172.16.0.106_o
iptables -A FORWARD -d 172.16.0.106 -j 172.16.0.106_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:1691 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:1691 classid 1:169a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:1691 classid 1:169b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 16901 fw classid 1:169a
tc filter add dev eth0 protocol ip parent 1: handle 16902 fw classid 1:169b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:1690 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:1690 classid 1:169d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:1690 classid 1:169e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 16904 fw classid 1:169d
tc filter add dev eth1 protocol ip parent 1: handle 16905 fw classid 1:169e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.106 --set-mark 16902
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.106 --set-mark 16905

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.106 -p tcp --dport 22 --set-mark 16904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.106 -p tcp --sport 22 --set-mark 16901
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.106 -p udp --dport 53 --set-mark 16904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.106 -p udp --sport 53 --set-mark 16901
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.106 -p tcp --dport 80 --set-mark 16904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.106 -p tcp --sport 80 --set-mark 16901
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.106 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.106 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC 1	IP:101    ID: 170
#------------------------------------------------------------------------------
iptables -X 172.16.0.101_i
iptables -X 172.16.0.101_o
iptables -N 172.16.0.101_i
iptables -N 172.16.0.101_o
iptables -F 172.16.0.101_i
iptables -F 172.16.0.101_o
iptables -A FORWARD -s 172.16.0.101 -j 172.16.0.101_o
iptables -A FORWARD -d 172.16.0.101 -j 172.16.0.101_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:1701 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:1701 classid 1:170a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:1701 classid 1:170b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 17001 fw classid 1:170a
tc filter add dev eth0 protocol ip parent 1: handle 17002 fw classid 1:170b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:1700 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:1700 classid 1:170d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:1700 classid 1:170e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 17004 fw classid 1:170d
tc filter add dev eth1 protocol ip parent 1: handle 17005 fw classid 1:170e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.101 --set-mark 17002
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.101 --set-mark 17005

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.101 -p tcp --dport 22 --set-mark 17004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.101 -p tcp --sport 22 --set-mark 17001
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.101 -p udp --dport 53 --set-mark 17004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.101 -p udp --sport 53 --set-mark 17001
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.101 -p tcp --dport 80 --set-mark 17004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.101 -p tcp --sport 80 --set-mark 17001
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.101 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.101 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC22	IP:122    ID: 177
#------------------------------------------------------------------------------
iptables -X 172.16.0.122_i
iptables -X 172.16.0.122_o
iptables -N 172.16.0.122_i
iptables -N 172.16.0.122_o
iptables -F 172.16.0.122_i
iptables -F 172.16.0.122_o
iptables -A FORWARD -s 172.16.0.122 -j 172.16.0.122_o
iptables -A FORWARD -d 172.16.0.122 -j 172.16.0.122_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:1771 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:1771 classid 1:177a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:1771 classid 1:177b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 17701 fw classid 1:177a
tc filter add dev eth0 protocol ip parent 1: handle 17702 fw classid 1:177b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:1770 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:1770 classid 1:177d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:1770 classid 1:177e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 17704 fw classid 1:177d
tc filter add dev eth1 protocol ip parent 1: handle 17705 fw classid 1:177e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.122 --set-mark 17702
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.122 --set-mark 17705

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.122 -p tcp --dport 22 --set-mark 17704
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.122 -p tcp --sport 22 --set-mark 17701
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.122 -p udp --dport 53 --set-mark 17704
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.122 -p udp --sport 53 --set-mark 17701
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.122 -p tcp --dport 80 --set-mark 17704
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.122 -p tcp --sport 80 --set-mark 17701
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.122 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.122 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC51	IP:79    ID: 180
#------------------------------------------------------------------------------
iptables -X 172.16.0.79_i
iptables -X 172.16.0.79_o
iptables -N 172.16.0.79_i
iptables -N 172.16.0.79_o
iptables -F 172.16.0.79_i
iptables -F 172.16.0.79_o
iptables -A FORWARD -s 172.16.0.79 -j 172.16.0.79_o
iptables -A FORWARD -d 172.16.0.79 -j 172.16.0.79_i
iptables -A FORWARD -s 172.16.0.79 -m mac --mac-source 10:78:d2:1b:9b:c3 -j ACCEPT
iptables -A FORWARD -d 172.16.0.79 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:1801 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:1801 classid 1:180a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:1801 classid 1:180b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 18001 fw classid 1:180a
tc filter add dev eth0 protocol ip parent 1: handle 18002 fw classid 1:180b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:1800 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:1800 classid 1:180d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:1800 classid 1:180e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 18004 fw classid 1:180d
tc filter add dev eth1 protocol ip parent 1: handle 18005 fw classid 1:180e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.79 --set-mark 18002
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.79 --set-mark 18005

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.79 -p tcp --dport 22 --set-mark 18004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.79 -p tcp --sport 22 --set-mark 18001
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.79 -p udp --dport 53 --set-mark 18004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.79 -p udp --sport 53 --set-mark 18001
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.79 -p tcp --dport 80 --set-mark 18004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.79 -p tcp --sport 80 --set-mark 18001
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.79 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.79 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Sonia Toconas	IP:100    ID: 185
#------------------------------------------------------------------------------
iptables -X 172.16.0.100_i
iptables -X 172.16.0.100_o
iptables -N 172.16.0.100_i
iptables -N 172.16.0.100_o
iptables -F 172.16.0.100_i
iptables -F 172.16.0.100_o
iptables -A FORWARD -s 172.16.0.100 -j 172.16.0.100_o
iptables -A FORWARD -d 172.16.0.100 -j 172.16.0.100_i
iptables -A FORWARD -s 172.16.0.100 -m mac --mac-source 10:78:D2:8A:43:EF -j ACCEPT
iptables -A FORWARD -d 172.16.0.100 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:1851 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:1851 classid 1:185a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:1851 classid 1:185b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 18501 fw classid 1:185a
tc filter add dev eth0 protocol ip parent 1: handle 18502 fw classid 1:185b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:1850 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:1850 classid 1:185d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:1850 classid 1:185e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 18504 fw classid 1:185d
tc filter add dev eth1 protocol ip parent 1: handle 18505 fw classid 1:185e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.100 --set-mark 18502
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.100 --set-mark 18505

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.100 -p tcp --dport 22 --set-mark 18504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.100 -p tcp --sport 22 --set-mark 18501
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.100 -p udp --dport 53 --set-mark 18504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.100 -p udp --sport 53 --set-mark 18501
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.100 -p tcp --dport 80 --set-mark 18504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.100 -p tcp --sport 80 --set-mark 18501
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.100 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.100 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC25	IP:125    ID: 196
#------------------------------------------------------------------------------
iptables -X 172.16.0.125_i
iptables -X 172.16.0.125_o
iptables -N 172.16.0.125_i
iptables -N 172.16.0.125_o
iptables -F 172.16.0.125_i
iptables -F 172.16.0.125_o
iptables -A FORWARD -s 172.16.0.125 -j 172.16.0.125_o
iptables -A FORWARD -d 172.16.0.125 -j 172.16.0.125_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:1961 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:1961 classid 1:196a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:1961 classid 1:196b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 19601 fw classid 1:196a
tc filter add dev eth0 protocol ip parent 1: handle 19602 fw classid 1:196b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:1960 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:1960 classid 1:196d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:1960 classid 1:196e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 19604 fw classid 1:196d
tc filter add dev eth1 protocol ip parent 1: handle 19605 fw classid 1:196e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.125 --set-mark 19602
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.125 --set-mark 19605

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.125 -p tcp --dport 22 --set-mark 19604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.125 -p tcp --sport 22 --set-mark 19601
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.125 -p udp --dport 53 --set-mark 19604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.125 -p udp --sport 53 --set-mark 19601
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.125 -p tcp --dport 80 --set-mark 19604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.125 -p tcp --sport 80 --set-mark 19601
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.125 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.125 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - DVR 2	IP:8    ID: 200
#------------------------------------------------------------------------------
iptables -X 172.16.0.8_i
iptables -X 172.16.0.8_o
iptables -N 172.16.0.8_i
iptables -N 172.16.0.8_o
iptables -F 172.16.0.8_i
iptables -F 172.16.0.8_o
iptables -A FORWARD -s 172.16.0.8 -j 172.16.0.8_o
iptables -A FORWARD -d 172.16.0.8 -j 172.16.0.8_i
iptables -A FORWARD -s 172.16.0.8 -m mac --mac-source 00:6b:58:2c:2c:55 -j ACCEPT
iptables -A FORWARD -d 172.16.0.8 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2001 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:2001 classid 1:200a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:2001 classid 1:200b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 20001 fw classid 1:200a
tc filter add dev eth0 protocol ip parent 1: handle 20002 fw classid 1:200b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2000 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:2000 classid 1:200d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:2000 classid 1:200e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 20004 fw classid 1:200d
tc filter add dev eth1 protocol ip parent 1: handle 20005 fw classid 1:200e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.8 --set-mark 20002
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.8 --set-mark 20005

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.8 -p tcp --dport 22 --set-mark 20004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.8 -p tcp --sport 22 --set-mark 20001
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.8 -p udp --dport 53 --set-mark 20004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.8 -p udp --sport 53 --set-mark 20001
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.8 -p tcp --dport 80 --set-mark 20004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.8 -p tcp --sport 80 --set-mark 20001
iptables -t nat -A POSTROUTING -s 172.16.0.8 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - DVR 1	IP:9    ID: 201
#------------------------------------------------------------------------------
iptables -X 172.16.0.9_i
iptables -X 172.16.0.9_o
iptables -N 172.16.0.9_i
iptables -N 172.16.0.9_o
iptables -F 172.16.0.9_i
iptables -F 172.16.0.9_o
iptables -A FORWARD -s 172.16.0.9 -j 172.16.0.9_o
iptables -A FORWARD -d 172.16.0.9 -j 172.16.0.9_i
iptables -A FORWARD -s 172.16.0.9 -m mac --mac-source 00:5e:09:07:fc:0a -j ACCEPT
iptables -A FORWARD -d 172.16.0.9 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2011 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:2011 classid 1:201a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:2011 classid 1:201b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 20101 fw classid 1:201a
tc filter add dev eth0 protocol ip parent 1: handle 20102 fw classid 1:201b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2010 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:2010 classid 1:201d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:2010 classid 1:201e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 20104 fw classid 1:201d
tc filter add dev eth1 protocol ip parent 1: handle 20105 fw classid 1:201e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.9 --set-mark 20102
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.9 --set-mark 20105

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.9 -p tcp --dport 22 --set-mark 20104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.9 -p tcp --sport 22 --set-mark 20101
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.9 -p udp --dport 53 --set-mark 20104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.9 -p udp --sport 53 --set-mark 20101
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.9 -p tcp --dport 80 --set-mark 20104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.9 -p tcp --sport 80 --set-mark 20101
iptables -t nat -A POSTROUTING -s 172.16.0.9 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC19	IP:119    ID: 206
#------------------------------------------------------------------------------
iptables -X 172.16.0.119_i
iptables -X 172.16.0.119_o
iptables -N 172.16.0.119_i
iptables -N 172.16.0.119_o
iptables -F 172.16.0.119_i
iptables -F 172.16.0.119_o
iptables -A FORWARD -s 172.16.0.119 -j 172.16.0.119_o
iptables -A FORWARD -d 172.16.0.119 -j 172.16.0.119_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2061 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:2061 classid 1:206a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:2061 classid 1:206b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 20601 fw classid 1:206a
tc filter add dev eth0 protocol ip parent 1: handle 20602 fw classid 1:206b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2060 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:2060 classid 1:206d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:2060 classid 1:206e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 20604 fw classid 1:206d
tc filter add dev eth1 protocol ip parent 1: handle 20605 fw classid 1:206e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.119 --set-mark 20602
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.119 --set-mark 20605

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.119 -p tcp --dport 22 --set-mark 20604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.119 -p tcp --sport 22 --set-mark 20601
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.119 -p udp --dport 53 --set-mark 20604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.119 -p udp --sport 53 --set-mark 20601
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.119 -p tcp --dport 80 --set-mark 20604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.119 -p tcp --sport 80 --set-mark 20601
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.119 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.119 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC10	IP:110    ID: 207
#------------------------------------------------------------------------------
iptables -X 172.16.0.110_i
iptables -X 172.16.0.110_o
iptables -N 172.16.0.110_i
iptables -N 172.16.0.110_o
iptables -F 172.16.0.110_i
iptables -F 172.16.0.110_o
iptables -A FORWARD -s 172.16.0.110 -j 172.16.0.110_o
iptables -A FORWARD -d 172.16.0.110 -j 172.16.0.110_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2071 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:2071 classid 1:207a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:2071 classid 1:207b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 20701 fw classid 1:207a
tc filter add dev eth0 protocol ip parent 1: handle 20702 fw classid 1:207b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2070 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:2070 classid 1:207d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:2070 classid 1:207e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 20704 fw classid 1:207d
tc filter add dev eth1 protocol ip parent 1: handle 20705 fw classid 1:207e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.110 --set-mark 20702
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.110 --set-mark 20705

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.110 -p tcp --dport 22 --set-mark 20704
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.110 -p tcp --sport 22 --set-mark 20701
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.110 -p udp --dport 53 --set-mark 20704
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.110 -p udp --sport 53 --set-mark 20701
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.110 -p tcp --dport 80 --set-mark 20704
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.110 -p tcp --sport 80 --set-mark 20701
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.110 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.110 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC23	IP:123    ID: 209
#------------------------------------------------------------------------------
iptables -X 172.16.0.123_i
iptables -X 172.16.0.123_o
iptables -N 172.16.0.123_i
iptables -N 172.16.0.123_o
iptables -F 172.16.0.123_i
iptables -F 172.16.0.123_o
iptables -A FORWARD -s 172.16.0.123 -j 172.16.0.123_o
iptables -A FORWARD -d 172.16.0.123 -j 172.16.0.123_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2091 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:2091 classid 1:209a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:2091 classid 1:209b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 20901 fw classid 1:209a
tc filter add dev eth0 protocol ip parent 1: handle 20902 fw classid 1:209b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2090 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:2090 classid 1:209d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:2090 classid 1:209e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 20904 fw classid 1:209d
tc filter add dev eth1 protocol ip parent 1: handle 20905 fw classid 1:209e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.123 --set-mark 20902
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.123 --set-mark 20905

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.123 -p tcp --dport 22 --set-mark 20904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.123 -p tcp --sport 22 --set-mark 20901
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.123 -p udp --dport 53 --set-mark 20904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.123 -p udp --sport 53 --set-mark 20901
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.123 -p tcp --dport 80 --set-mark 20904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.123 -p tcp --sport 80 --set-mark 20901
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.123 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.123 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC20	IP:120    ID: 210
#------------------------------------------------------------------------------
iptables -X 172.16.0.120_i
iptables -X 172.16.0.120_o
iptables -N 172.16.0.120_i
iptables -N 172.16.0.120_o
iptables -F 172.16.0.120_i
iptables -F 172.16.0.120_o
iptables -A FORWARD -s 172.16.0.120 -j 172.16.0.120_o
iptables -A FORWARD -d 172.16.0.120 -j 172.16.0.120_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2101 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:2101 classid 1:210a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:2101 classid 1:210b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 21001 fw classid 1:210a
tc filter add dev eth0 protocol ip parent 1: handle 21002 fw classid 1:210b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2100 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:2100 classid 1:210d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:2100 classid 1:210e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 21004 fw classid 1:210d
tc filter add dev eth1 protocol ip parent 1: handle 21005 fw classid 1:210e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.120 --set-mark 21002
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.120 --set-mark 21005

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.120 -p tcp --dport 22 --set-mark 21004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.120 -p tcp --sport 22 --set-mark 21001
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.120 -p udp --dport 53 --set-mark 21004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.120 -p udp --sport 53 --set-mark 21001
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.120 -p tcp --dport 80 --set-mark 21004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.120 -p tcp --sport 80 --set-mark 21001
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.120 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.120 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC21	IP:121    ID: 219
#------------------------------------------------------------------------------
iptables -X 172.16.0.121_i
iptables -X 172.16.0.121_o
iptables -N 172.16.0.121_i
iptables -N 172.16.0.121_o
iptables -F 172.16.0.121_i
iptables -F 172.16.0.121_o
iptables -A FORWARD -s 172.16.0.121 -j 172.16.0.121_o
iptables -A FORWARD -d 172.16.0.121 -j 172.16.0.121_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2191 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:2191 classid 1:219a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:2191 classid 1:219b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 21901 fw classid 1:219a
tc filter add dev eth0 protocol ip parent 1: handle 21902 fw classid 1:219b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2190 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:2190 classid 1:219d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:2190 classid 1:219e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 21904 fw classid 1:219d
tc filter add dev eth1 protocol ip parent 1: handle 21905 fw classid 1:219e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.121 --set-mark 21902
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.121 --set-mark 21905

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.121 -p tcp --dport 22 --set-mark 21904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.121 -p tcp --sport 22 --set-mark 21901
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.121 -p udp --dport 53 --set-mark 21904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.121 -p udp --sport 53 --set-mark 21901
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.121 -p tcp --dport 80 --set-mark 21904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.121 -p tcp --sport 80 --set-mark 21901
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.121 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.121 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - ICS-100 Call Center	IP:22    ID: 220
#------------------------------------------------------------------------------
iptables -X 172.16.0.22_i
iptables -X 172.16.0.22_o
iptables -N 172.16.0.22_i
iptables -N 172.16.0.22_o
iptables -F 172.16.0.22_i
iptables -F 172.16.0.22_o
iptables -A FORWARD -s 172.16.0.22 -j 172.16.0.22_o
iptables -A FORWARD -d 172.16.0.22 -j 172.16.0.22_i
iptables -A FORWARD -s 172.16.0.22 -m mac --mac-source 00:30:4f:79:29:f9 -j ACCEPT
iptables -A FORWARD -d 172.16.0.22 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2201 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:2201 classid 1:220a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:2201 classid 1:220b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 22001 fw classid 1:220a
tc filter add dev eth0 protocol ip parent 1: handle 22002 fw classid 1:220b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2200 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:2200 classid 1:220d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:2200 classid 1:220e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 22004 fw classid 1:220d
tc filter add dev eth1 protocol ip parent 1: handle 22005 fw classid 1:220e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.22 --set-mark 22002
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.22 --set-mark 22005

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.22 -p tcp --dport 22 --set-mark 22004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.22 -p tcp --sport 22 --set-mark 22001
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.22 -p udp --dport 53 --set-mark 22004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.22 -p udp --sport 53 --set-mark 22001
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.22 -p tcp --dport 80 --set-mark 22004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.22 -p tcp --sport 80 --set-mark 22001
iptables -t nat -A POSTROUTING -s 172.16.0.22 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Telular 1	IP:3    ID: 221
#------------------------------------------------------------------------------
iptables -X 172.16.0.3_i
iptables -X 172.16.0.3_o
iptables -N 172.16.0.3_i
iptables -N 172.16.0.3_o
iptables -F 172.16.0.3_i
iptables -F 172.16.0.3_o
iptables -A FORWARD -s 172.16.0.3 -j 172.16.0.3_o
iptables -A FORWARD -d 172.16.0.3 -j 172.16.0.3_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2211 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:2211 classid 1:221a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:2211 classid 1:221b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 22101 fw classid 1:221a
tc filter add dev eth0 protocol ip parent 1: handle 22102 fw classid 1:221b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2210 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:2210 classid 1:221d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:2210 classid 1:221e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 22104 fw classid 1:221d
tc filter add dev eth1 protocol ip parent 1: handle 22105 fw classid 1:221e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.3 --set-mark 22102
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.3 --set-mark 22105

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.3 -p tcp --dport 22 --set-mark 22104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.3 -p tcp --sport 22 --set-mark 22101
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.3 -p udp --dport 53 --set-mark 22104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.3 -p udp --sport 53 --set-mark 22101
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.3 -p tcp --dport 80 --set-mark 22104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.3 -p tcp --sport 80 --set-mark 22101
iptables -t nat -A POSTROUTING -s 172.16.0.3 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC11	IP:111    ID: 223
#------------------------------------------------------------------------------
iptables -X 172.16.0.111_i
iptables -X 172.16.0.111_o
iptables -N 172.16.0.111_i
iptables -N 172.16.0.111_o
iptables -F 172.16.0.111_i
iptables -F 172.16.0.111_o
iptables -A FORWARD -s 172.16.0.111 -j 172.16.0.111_o
iptables -A FORWARD -d 172.16.0.111 -j 172.16.0.111_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2231 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:2231 classid 1:223a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:2231 classid 1:223b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 22301 fw classid 1:223a
tc filter add dev eth0 protocol ip parent 1: handle 22302 fw classid 1:223b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2230 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:2230 classid 1:223d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:2230 classid 1:223e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 22304 fw classid 1:223d
tc filter add dev eth1 protocol ip parent 1: handle 22305 fw classid 1:223e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.111 --set-mark 22302
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.111 --set-mark 22305

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.111 -p tcp --dport 22 --set-mark 22304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.111 -p tcp --sport 22 --set-mark 22301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.111 -p udp --dport 53 --set-mark 22304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.111 -p udp --sport 53 --set-mark 22301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.111 -p tcp --dport 80 --set-mark 22304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.111 -p tcp --sport 80 --set-mark 22301
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.111 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.111 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Office	IP:40    ID: 224
#------------------------------------------------------------------------------
iptables -X 172.16.0.40_i
iptables -X 172.16.0.40_o
iptables -N 172.16.0.40_i
iptables -N 172.16.0.40_o
iptables -F 172.16.0.40_i
iptables -F 172.16.0.40_o
iptables -A FORWARD -s 172.16.0.40 -j 172.16.0.40_o
iptables -A FORWARD -d 172.16.0.40 -j 172.16.0.40_i
iptables -A FORWARD -s 172.16.0.40 -m mac --mac-source 00:40:01:2e:15:55 -j ACCEPT
iptables -A FORWARD -d 172.16.0.40 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2241 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:2241 classid 1:224a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:2241 classid 1:224b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 22401 fw classid 1:224a
tc filter add dev eth0 protocol ip parent 1: handle 22402 fw classid 1:224b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2240 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:2240 classid 1:224d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:2240 classid 1:224e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 22404 fw classid 1:224d
tc filter add dev eth1 protocol ip parent 1: handle 22405 fw classid 1:224e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.40 --set-mark 22402
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.40 --set-mark 22405

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.40 -p tcp --dport 22 --set-mark 22404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.40 -p tcp --sport 22 --set-mark 22401
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.40 -p udp --dport 53 --set-mark 22404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.40 -p udp --sport 53 --set-mark 22401
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.40 -p tcp --dport 80 --set-mark 22404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.40 -p tcp --sport 80 --set-mark 22401
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.40 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.40 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC50	IP:75    ID: 225
#------------------------------------------------------------------------------
iptables -X 172.16.0.75_i
iptables -X 172.16.0.75_o
iptables -N 172.16.0.75_i
iptables -N 172.16.0.75_o
iptables -F 172.16.0.75_i
iptables -F 172.16.0.75_o
iptables -A FORWARD -s 172.16.0.75 -j 172.16.0.75_o
iptables -A FORWARD -d 172.16.0.75 -j 172.16.0.75_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2251 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:2251 classid 1:225a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:2251 classid 1:225b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 22501 fw classid 1:225a
tc filter add dev eth0 protocol ip parent 1: handle 22502 fw classid 1:225b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2250 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:2250 classid 1:225d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:2250 classid 1:225e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 22504 fw classid 1:225d
tc filter add dev eth1 protocol ip parent 1: handle 22505 fw classid 1:225e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.75 --set-mark 22502
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.75 --set-mark 22505

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.75 -p tcp --dport 22 --set-mark 22504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.75 -p tcp --sport 22 --set-mark 22501
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.75 -p udp --dport 53 --set-mark 22504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.75 -p udp --sport 53 --set-mark 22501
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.75 -p tcp --dport 80 --set-mark 22504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.75 -p tcp --sport 80 --set-mark 22501
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.75 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.75 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC44	IP:144    ID: 226
#------------------------------------------------------------------------------
iptables -X 172.16.0.144_i
iptables -X 172.16.0.144_o
iptables -N 172.16.0.144_i
iptables -N 172.16.0.144_o
iptables -F 172.16.0.144_i
iptables -F 172.16.0.144_o
iptables -A FORWARD -s 172.16.0.144 -j 172.16.0.144_o
iptables -A FORWARD -d 172.16.0.144 -j 172.16.0.144_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2261 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:2261 classid 1:226a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:2261 classid 1:226b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 22601 fw classid 1:226a
tc filter add dev eth0 protocol ip parent 1: handle 22602 fw classid 1:226b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2260 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:2260 classid 1:226d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:2260 classid 1:226e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 22604 fw classid 1:226d
tc filter add dev eth1 protocol ip parent 1: handle 22605 fw classid 1:226e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.144 --set-mark 22602
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.144 --set-mark 22605

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.144 -p tcp --dport 22 --set-mark 22604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.144 -p tcp --sport 22 --set-mark 22601
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.144 -p udp --dport 53 --set-mark 22604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.144 -p udp --sport 53 --set-mark 22601
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.144 -p tcp --dport 80 --set-mark 22604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.144 -p tcp --sport 80 --set-mark 22601
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.144 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.144 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Controlador Fiscal 1	IP:57    ID: 231
#------------------------------------------------------------------------------
iptables -X 172.16.0.57_i
iptables -X 172.16.0.57_o
iptables -N 172.16.0.57_i
iptables -N 172.16.0.57_o
iptables -F 172.16.0.57_i
iptables -F 172.16.0.57_o
iptables -A FORWARD -s 172.16.0.57 -j 172.16.0.57_o
iptables -A FORWARD -d 172.16.0.57 -j 172.16.0.57_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2311 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:2311 classid 1:231a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:2311 classid 1:231b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 23101 fw classid 1:231a
tc filter add dev eth0 protocol ip parent 1: handle 23102 fw classid 1:231b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2310 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:2310 classid 1:231d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:2310 classid 1:231e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 23104 fw classid 1:231d
tc filter add dev eth1 protocol ip parent 1: handle 23105 fw classid 1:231e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.57 --set-mark 23102
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.57 --set-mark 23105

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.57 -p tcp --dport 22 --set-mark 23104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.57 -p tcp --sport 22 --set-mark 23101
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.57 -p udp --dport 53 --set-mark 23104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.57 -p udp --sport 53 --set-mark 23101
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.57 -p tcp --dport 80 --set-mark 23104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.57 -p tcp --sport 80 --set-mark 23101
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.57 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.57 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC31	IP:131    ID: 243
#------------------------------------------------------------------------------
iptables -X 172.16.0.131_i
iptables -X 172.16.0.131_o
iptables -N 172.16.0.131_i
iptables -N 172.16.0.131_o
iptables -F 172.16.0.131_i
iptables -F 172.16.0.131_o
iptables -A FORWARD -s 172.16.0.131 -j 172.16.0.131_o
iptables -A FORWARD -d 172.16.0.131 -j 172.16.0.131_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2431 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:2431 classid 1:243a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:2431 classid 1:243b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 24301 fw classid 1:243a
tc filter add dev eth0 protocol ip parent 1: handle 24302 fw classid 1:243b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2430 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:2430 classid 1:243d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:2430 classid 1:243e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 24304 fw classid 1:243d
tc filter add dev eth1 protocol ip parent 1: handle 24305 fw classid 1:243e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.131 --set-mark 24302
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.131 --set-mark 24305

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.131 -p tcp --dport 22 --set-mark 24304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.131 -p tcp --sport 22 --set-mark 24301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.131 -p udp --dport 53 --set-mark 24304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.131 -p udp --sport 53 --set-mark 24301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.131 -p tcp --dport 80 --set-mark 24304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.131 -p tcp --sport 80 --set-mark 24301
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.131 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.131 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC39	IP:139    ID: 269
#------------------------------------------------------------------------------
iptables -X 172.16.0.139_i
iptables -X 172.16.0.139_o
iptables -N 172.16.0.139_i
iptables -N 172.16.0.139_o
iptables -F 172.16.0.139_i
iptables -F 172.16.0.139_o
iptables -A FORWARD -s 172.16.0.139 -j 172.16.0.139_o
iptables -A FORWARD -d 172.16.0.139 -j 172.16.0.139_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2691 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:2691 classid 1:269a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:2691 classid 1:269b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 26901 fw classid 1:269a
tc filter add dev eth0 protocol ip parent 1: handle 26902 fw classid 1:269b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2690 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:2690 classid 1:269d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:2690 classid 1:269e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 26904 fw classid 1:269d
tc filter add dev eth1 protocol ip parent 1: handle 26905 fw classid 1:269e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.139 --set-mark 26902
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.139 --set-mark 26905

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.139 -p tcp --dport 22 --set-mark 26904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.139 -p tcp --sport 22 --set-mark 26901
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.139 -p udp --dport 53 --set-mark 26904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.139 -p udp --sport 53 --set-mark 26901
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.139 -p tcp --dport 80 --set-mark 26904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.139 -p tcp --sport 80 --set-mark 26901
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.139 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.139 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC27	IP:127    ID: 244
#------------------------------------------------------------------------------
iptables -X 172.16.0.127_i
iptables -X 172.16.0.127_o
iptables -N 172.16.0.127_i
iptables -N 172.16.0.127_o
iptables -F 172.16.0.127_i
iptables -F 172.16.0.127_o
iptables -A FORWARD -s 172.16.0.127 -j 172.16.0.127_o
iptables -A FORWARD -d 172.16.0.127 -j 172.16.0.127_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2441 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:2441 classid 1:244a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:2441 classid 1:244b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 24401 fw classid 1:244a
tc filter add dev eth0 protocol ip parent 1: handle 24402 fw classid 1:244b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2440 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:2440 classid 1:244d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:2440 classid 1:244e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 24404 fw classid 1:244d
tc filter add dev eth1 protocol ip parent 1: handle 24405 fw classid 1:244e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.127 --set-mark 24402
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.127 --set-mark 24405

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.127 -p tcp --dport 22 --set-mark 24404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.127 -p tcp --sport 22 --set-mark 24401
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.127 -p udp --dport 53 --set-mark 24404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.127 -p udp --sport 53 --set-mark 24401
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.127 -p tcp --dport 80 --set-mark 24404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.127 -p tcp --sport 80 --set-mark 24401
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.127 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.127 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC40	IP:140    ID: 245
#------------------------------------------------------------------------------
iptables -X 172.16.0.140_i
iptables -X 172.16.0.140_o
iptables -N 172.16.0.140_i
iptables -N 172.16.0.140_o
iptables -F 172.16.0.140_i
iptables -F 172.16.0.140_o
iptables -A FORWARD -s 172.16.0.140 -j 172.16.0.140_o
iptables -A FORWARD -d 172.16.0.140 -j 172.16.0.140_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2451 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:2451 classid 1:245a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:2451 classid 1:245b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 24501 fw classid 1:245a
tc filter add dev eth0 protocol ip parent 1: handle 24502 fw classid 1:245b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2450 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:2450 classid 1:245d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:2450 classid 1:245e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 24504 fw classid 1:245d
tc filter add dev eth1 protocol ip parent 1: handle 24505 fw classid 1:245e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.140 --set-mark 24502
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.140 --set-mark 24505

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.140 -p tcp --dport 22 --set-mark 24504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.140 -p tcp --sport 22 --set-mark 24501
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.140 -p udp --dport 53 --set-mark 24504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.140 -p udp --sport 53 --set-mark 24501
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.140 -p tcp --dport 80 --set-mark 24504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.140 -p tcp --sport 80 --set-mark 24501
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.140 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.140 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC32	IP:132    ID: 251
#------------------------------------------------------------------------------
iptables -X 172.16.0.132_i
iptables -X 172.16.0.132_o
iptables -N 172.16.0.132_i
iptables -N 172.16.0.132_o
iptables -F 172.16.0.132_i
iptables -F 172.16.0.132_o
iptables -A FORWARD -s 172.16.0.132 -j 172.16.0.132_o
iptables -A FORWARD -d 172.16.0.132 -j 172.16.0.132_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2511 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:2511 classid 1:251a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:2511 classid 1:251b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 25101 fw classid 1:251a
tc filter add dev eth0 protocol ip parent 1: handle 25102 fw classid 1:251b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2510 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:2510 classid 1:251d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:2510 classid 1:251e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 25104 fw classid 1:251d
tc filter add dev eth1 protocol ip parent 1: handle 25105 fw classid 1:251e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.132 --set-mark 25102
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.132 --set-mark 25105

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.132 -p tcp --dport 22 --set-mark 25104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.132 -p tcp --sport 22 --set-mark 25101
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.132 -p udp --dport 53 --set-mark 25104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.132 -p udp --sport 53 --set-mark 25101
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.132 -p tcp --dport 80 --set-mark 25104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.132 -p tcp --sport 80 --set-mark 25101
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.132 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.132 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC28	IP:128    ID: 246
#------------------------------------------------------------------------------
iptables -X 172.16.0.128_i
iptables -X 172.16.0.128_o
iptables -N 172.16.0.128_i
iptables -N 172.16.0.128_o
iptables -F 172.16.0.128_i
iptables -F 172.16.0.128_o
iptables -A FORWARD -s 172.16.0.128 -j 172.16.0.128_o
iptables -A FORWARD -d 172.16.0.128 -j 172.16.0.128_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2461 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:2461 classid 1:246a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:2461 classid 1:246b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 24601 fw classid 1:246a
tc filter add dev eth0 protocol ip parent 1: handle 24602 fw classid 1:246b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2460 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:2460 classid 1:246d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:2460 classid 1:246e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 24604 fw classid 1:246d
tc filter add dev eth1 protocol ip parent 1: handle 24605 fw classid 1:246e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.128 --set-mark 24602
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.128 --set-mark 24605

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.128 -p tcp --dport 22 --set-mark 24604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.128 -p tcp --sport 22 --set-mark 24601
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.128 -p udp --dport 53 --set-mark 24604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.128 -p udp --sport 53 --set-mark 24601
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.128 -p tcp --dport 80 --set-mark 24604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.128 -p tcp --sport 80 --set-mark 24601
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.128 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.128 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC33	IP:133    ID: 247
#------------------------------------------------------------------------------
iptables -X 172.16.0.133_i
iptables -X 172.16.0.133_o
iptables -N 172.16.0.133_i
iptables -N 172.16.0.133_o
iptables -F 172.16.0.133_i
iptables -F 172.16.0.133_o
iptables -A FORWARD -s 172.16.0.133 -j 172.16.0.133_o
iptables -A FORWARD -d 172.16.0.133 -j 172.16.0.133_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2471 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:2471 classid 1:247a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:2471 classid 1:247b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 24701 fw classid 1:247a
tc filter add dev eth0 protocol ip parent 1: handle 24702 fw classid 1:247b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2470 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:2470 classid 1:247d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:2470 classid 1:247e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 24704 fw classid 1:247d
tc filter add dev eth1 protocol ip parent 1: handle 24705 fw classid 1:247e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.133 --set-mark 24702
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.133 --set-mark 24705

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.133 -p tcp --dport 22 --set-mark 24704
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.133 -p tcp --sport 22 --set-mark 24701
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.133 -p udp --dport 53 --set-mark 24704
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.133 -p udp --sport 53 --set-mark 24701
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.133 -p tcp --dport 80 --set-mark 24704
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.133 -p tcp --sport 80 --set-mark 24701
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.133 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.133 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC30	IP:130    ID: 248
#------------------------------------------------------------------------------
iptables -X 172.16.0.130_i
iptables -X 172.16.0.130_o
iptables -N 172.16.0.130_i
iptables -N 172.16.0.130_o
iptables -F 172.16.0.130_i
iptables -F 172.16.0.130_o
iptables -A FORWARD -s 172.16.0.130 -j 172.16.0.130_o
iptables -A FORWARD -d 172.16.0.130 -j 172.16.0.130_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2481 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:2481 classid 1:248a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:2481 classid 1:248b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 24801 fw classid 1:248a
tc filter add dev eth0 protocol ip parent 1: handle 24802 fw classid 1:248b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2480 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:2480 classid 1:248d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:2480 classid 1:248e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 24804 fw classid 1:248d
tc filter add dev eth1 protocol ip parent 1: handle 24805 fw classid 1:248e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.130 --set-mark 24802
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.130 --set-mark 24805

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.130 -p tcp --dport 22 --set-mark 24804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.130 -p tcp --sport 22 --set-mark 24801
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.130 -p udp --dport 53 --set-mark 24804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.130 -p udp --sport 53 --set-mark 24801
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.130 -p tcp --dport 80 --set-mark 24804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.130 -p tcp --sport 80 --set-mark 24801
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.130 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.130 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC29	IP:129    ID: 250
#------------------------------------------------------------------------------
iptables -X 172.16.0.129_i
iptables -X 172.16.0.129_o
iptables -N 172.16.0.129_i
iptables -N 172.16.0.129_o
iptables -F 172.16.0.129_i
iptables -F 172.16.0.129_o
iptables -A FORWARD -s 172.16.0.129 -j 172.16.0.129_o
iptables -A FORWARD -d 172.16.0.129 -j 172.16.0.129_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2501 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:2501 classid 1:250a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:2501 classid 1:250b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 25001 fw classid 1:250a
tc filter add dev eth0 protocol ip parent 1: handle 25002 fw classid 1:250b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2500 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:2500 classid 1:250d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:2500 classid 1:250e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 25004 fw classid 1:250d
tc filter add dev eth1 protocol ip parent 1: handle 25005 fw classid 1:250e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.129 --set-mark 25002
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.129 --set-mark 25005

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.129 -p tcp --dport 22 --set-mark 25004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.129 -p tcp --sport 22 --set-mark 25001
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.129 -p udp --dport 53 --set-mark 25004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.129 -p udp --sport 53 --set-mark 25001
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.129 -p tcp --dport 80 --set-mark 25004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.129 -p tcp --sport 80 --set-mark 25001
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.129 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.129 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC18	IP:118    ID: 252
#------------------------------------------------------------------------------
iptables -X 172.16.0.118_i
iptables -X 172.16.0.118_o
iptables -N 172.16.0.118_i
iptables -N 172.16.0.118_o
iptables -F 172.16.0.118_i
iptables -F 172.16.0.118_o
iptables -A FORWARD -s 172.16.0.118 -j 172.16.0.118_o
iptables -A FORWARD -d 172.16.0.118 -j 172.16.0.118_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2521 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:2521 classid 1:252a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:2521 classid 1:252b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 25201 fw classid 1:252a
tc filter add dev eth0 protocol ip parent 1: handle 25202 fw classid 1:252b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2520 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:2520 classid 1:252d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:2520 classid 1:252e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 25204 fw classid 1:252d
tc filter add dev eth1 protocol ip parent 1: handle 25205 fw classid 1:252e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.118 --set-mark 25202
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.118 --set-mark 25205

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.118 -p tcp --dport 22 --set-mark 25204
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.118 -p tcp --sport 22 --set-mark 25201
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.118 -p udp --dport 53 --set-mark 25204
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.118 -p udp --sport 53 --set-mark 25201
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.118 -p tcp --dport 80 --set-mark 25204
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.118 -p tcp --sport 80 --set-mark 25201
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.118 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.118 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Jose Lopez	IP:36    ID: 261
#------------------------------------------------------------------------------
iptables -X 172.16.0.36_i
iptables -X 172.16.0.36_o
iptables -N 172.16.0.36_i
iptables -N 172.16.0.36_o
iptables -F 172.16.0.36_i
iptables -F 172.16.0.36_o
iptables -A FORWARD -s 172.16.0.36 -j 172.16.0.36_o
iptables -A FORWARD -d 172.16.0.36 -j 172.16.0.36_i
iptables -A FORWARD -s 172.16.0.36 -m mac --mac-source e0:06:e6:07:3c:87 -j ACCEPT
iptables -A FORWARD -d 172.16.0.36 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2611 htb rate 2048kbit ceil 2048kbit burst 15k
tc class add dev eth0 parent 1:2611 classid 1:261a htb rate 819kbit ceil 2048kbit burst 15k prio 0
tc class add dev eth0 parent 1:2611 classid 1:261b htb rate 819kbit ceil 2048kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 26101 fw classid 1:261a
tc filter add dev eth0 protocol ip parent 1: handle 26102 fw classid 1:261b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2610 htb rate 2048kbit ceil 2048kbit burst 15k
tc class add dev eth1 parent 1:2610 classid 1:261d htb rate 819kbit ceil 2048kbit burst 15k prio 0
tc class add dev eth1 parent 1:2610 classid 1:261e htb rate 819kbit ceil 2048kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 26104 fw classid 1:261d
tc filter add dev eth1 protocol ip parent 1: handle 26105 fw classid 1:261e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.36 --set-mark 26102
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.36 --set-mark 26105

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.36 -p tcp --dport 22 --set-mark 26104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.36 -p tcp --sport 22 --set-mark 26101
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.36 -p udp --dport 53 --set-mark 26104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.36 -p udp --sport 53 --set-mark 26101
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.36 -p tcp --dport 80 --set-mark 26104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.36 -p tcp --sport 80 --set-mark 26101
iptables -t nat -A POSTROUTING -s 172.16.0.36 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC34	IP:134    ID: 265
#------------------------------------------------------------------------------
iptables -X 172.16.0.134_i
iptables -X 172.16.0.134_o
iptables -N 172.16.0.134_i
iptables -N 172.16.0.134_o
iptables -F 172.16.0.134_i
iptables -F 172.16.0.134_o
iptables -A FORWARD -s 172.16.0.134 -j 172.16.0.134_o
iptables -A FORWARD -d 172.16.0.134 -j 172.16.0.134_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2651 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:2651 classid 1:265a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:2651 classid 1:265b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 26501 fw classid 1:265a
tc filter add dev eth0 protocol ip parent 1: handle 26502 fw classid 1:265b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2650 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:2650 classid 1:265d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:2650 classid 1:265e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 26504 fw classid 1:265d
tc filter add dev eth1 protocol ip parent 1: handle 26505 fw classid 1:265e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.134 --set-mark 26502
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.134 --set-mark 26505

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.134 -p tcp --dport 22 --set-mark 26504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.134 -p tcp --sport 22 --set-mark 26501
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.134 -p udp --dport 53 --set-mark 26504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.134 -p udp --sport 53 --set-mark 26501
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.134 -p tcp --dport 80 --set-mark 26504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.134 -p tcp --sport 80 --set-mark 26501
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.134 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.134 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC38	IP:138    ID: 271
#------------------------------------------------------------------------------
iptables -X 172.16.0.138_i
iptables -X 172.16.0.138_o
iptables -N 172.16.0.138_i
iptables -N 172.16.0.138_o
iptables -F 172.16.0.138_i
iptables -F 172.16.0.138_o
iptables -A FORWARD -s 172.16.0.138 -j 172.16.0.138_o
iptables -A FORWARD -d 172.16.0.138 -j 172.16.0.138_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2711 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:2711 classid 1:271a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:2711 classid 1:271b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 27101 fw classid 1:271a
tc filter add dev eth0 protocol ip parent 1: handle 27102 fw classid 1:271b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2710 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:2710 classid 1:271d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:2710 classid 1:271e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 27104 fw classid 1:271d
tc filter add dev eth1 protocol ip parent 1: handle 27105 fw classid 1:271e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.138 --set-mark 27102
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.138 --set-mark 27105

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.138 -p tcp --dport 22 --set-mark 27104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.138 -p tcp --sport 22 --set-mark 27101
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.138 -p udp --dport 53 --set-mark 27104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.138 -p udp --sport 53 --set-mark 27101
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.138 -p tcp --dport 80 --set-mark 27104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.138 -p tcp --sport 80 --set-mark 27101
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.138 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.138 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC35	IP:135    ID: 272
#------------------------------------------------------------------------------
iptables -X 172.16.0.135_i
iptables -X 172.16.0.135_o
iptables -N 172.16.0.135_i
iptables -N 172.16.0.135_o
iptables -F 172.16.0.135_i
iptables -F 172.16.0.135_o
iptables -A FORWARD -s 172.16.0.135 -j 172.16.0.135_o
iptables -A FORWARD -d 172.16.0.135 -j 172.16.0.135_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2721 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:2721 classid 1:272a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:2721 classid 1:272b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 27201 fw classid 1:272a
tc filter add dev eth0 protocol ip parent 1: handle 27202 fw classid 1:272b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2720 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:2720 classid 1:272d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:2720 classid 1:272e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 27204 fw classid 1:272d
tc filter add dev eth1 protocol ip parent 1: handle 27205 fw classid 1:272e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.135 --set-mark 27202
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.135 --set-mark 27205

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.135 -p tcp --dport 22 --set-mark 27204
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.135 -p tcp --sport 22 --set-mark 27201
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.135 -p udp --dport 53 --set-mark 27204
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.135 -p udp --sport 53 --set-mark 27201
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.135 -p tcp --dport 80 --set-mark 27204
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.135 -p tcp --sport 80 --set-mark 27201
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.135 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.135 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC37	IP:137    ID: 273
#------------------------------------------------------------------------------
iptables -X 172.16.0.137_i
iptables -X 172.16.0.137_o
iptables -N 172.16.0.137_i
iptables -N 172.16.0.137_o
iptables -F 172.16.0.137_i
iptables -F 172.16.0.137_o
iptables -A FORWARD -s 172.16.0.137 -j 172.16.0.137_o
iptables -A FORWARD -d 172.16.0.137 -j 172.16.0.137_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2731 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:2731 classid 1:273a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:2731 classid 1:273b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 27301 fw classid 1:273a
tc filter add dev eth0 protocol ip parent 1: handle 27302 fw classid 1:273b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2730 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:2730 classid 1:273d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:2730 classid 1:273e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 27304 fw classid 1:273d
tc filter add dev eth1 protocol ip parent 1: handle 27305 fw classid 1:273e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.137 --set-mark 27302
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.137 --set-mark 27305

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.137 -p tcp --dport 22 --set-mark 27304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.137 -p tcp --sport 22 --set-mark 27301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.137 -p udp --dport 53 --set-mark 27304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.137 -p udp --sport 53 --set-mark 27301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.137 -p tcp --dport 80 --set-mark 27304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.137 -p tcp --sport 80 --set-mark 27301
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.137 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.137 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC36	IP:136    ID: 274
#------------------------------------------------------------------------------
iptables -X 172.16.0.136_i
iptables -X 172.16.0.136_o
iptables -N 172.16.0.136_i
iptables -N 172.16.0.136_o
iptables -F 172.16.0.136_i
iptables -F 172.16.0.136_o
iptables -A FORWARD -s 172.16.0.136 -j 172.16.0.136_o
iptables -A FORWARD -d 172.16.0.136 -j 172.16.0.136_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2741 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:2741 classid 1:274a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:2741 classid 1:274b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 27401 fw classid 1:274a
tc filter add dev eth0 protocol ip parent 1: handle 27402 fw classid 1:274b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2740 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:2740 classid 1:274d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:2740 classid 1:274e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 27404 fw classid 1:274d
tc filter add dev eth1 protocol ip parent 1: handle 27405 fw classid 1:274e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.136 --set-mark 27402
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.136 --set-mark 27405

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.136 -p tcp --dport 22 --set-mark 27404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.136 -p tcp --sport 22 --set-mark 27401
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.136 -p udp --dport 53 --set-mark 27404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.136 -p udp --sport 53 --set-mark 27401
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.136 -p tcp --dport 80 --set-mark 27404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.136 -p tcp --sport 80 --set-mark 27401
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.136 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.136 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Micronet	IP:4    ID: 281
#------------------------------------------------------------------------------
iptables -X 172.16.0.4_i
iptables -X 172.16.0.4_o
iptables -N 172.16.0.4_i
iptables -N 172.16.0.4_o
iptables -F 172.16.0.4_i
iptables -F 172.16.0.4_o
iptables -A FORWARD -s 172.16.0.4 -j 172.16.0.4_o
iptables -A FORWARD -d 172.16.0.4 -j 172.16.0.4_i
iptables -A FORWARD -s 172.16.0.4 -m mac --mac-source 00:11:3b:18:87:57 -j ACCEPT
iptables -A FORWARD -d 172.16.0.4 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2811 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:2811 classid 1:281a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:2811 classid 1:281b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 28101 fw classid 1:281a
tc filter add dev eth0 protocol ip parent 1: handle 28102 fw classid 1:281b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2810 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:2810 classid 1:281d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:2810 classid 1:281e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 28104 fw classid 1:281d
tc filter add dev eth1 protocol ip parent 1: handle 28105 fw classid 1:281e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.4 --set-mark 28102
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.4 --set-mark 28105

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.4 -p tcp --dport 22 --set-mark 28104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.4 -p tcp --sport 22 --set-mark 28101
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.4 -p udp --dport 53 --set-mark 28104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.4 -p udp --sport 53 --set-mark 28101
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.4 -p tcp --dport 80 --set-mark 28104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.4 -p tcp --sport 80 --set-mark 28101
iptables -t nat -A POSTROUTING -s 172.16.0.4 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Telular 2	IP:6    ID: 282
#------------------------------------------------------------------------------
iptables -X 172.16.0.6_i
iptables -X 172.16.0.6_o
iptables -N 172.16.0.6_i
iptables -N 172.16.0.6_o
iptables -F 172.16.0.6_i
iptables -F 172.16.0.6_o
iptables -A FORWARD -s 172.16.0.6 -j 172.16.0.6_o
iptables -A FORWARD -d 172.16.0.6 -j 172.16.0.6_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2821 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:2821 classid 1:282a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:2821 classid 1:282b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 28201 fw classid 1:282a
tc filter add dev eth0 protocol ip parent 1: handle 28202 fw classid 1:282b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2820 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:2820 classid 1:282d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:2820 classid 1:282e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 28204 fw classid 1:282d
tc filter add dev eth1 protocol ip parent 1: handle 28205 fw classid 1:282e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.6 --set-mark 28202
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.6 --set-mark 28205

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.6 -p tcp --dport 22 --set-mark 28204
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.6 -p tcp --sport 22 --set-mark 28201
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.6 -p udp --dport 53 --set-mark 28204
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.6 -p udp --sport 53 --set-mark 28201
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.6 -p tcp --dport 80 --set-mark 28204
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.6 -p tcp --sport 80 --set-mark 28201
iptables -t nat -A POSTROUTING -s 172.16.0.6 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Jose Lopez	IP:33    ID: 286
#------------------------------------------------------------------------------
iptables -X 172.16.0.33_i
iptables -X 172.16.0.33_o
iptables -N 172.16.0.33_i
iptables -N 172.16.0.33_o
iptables -F 172.16.0.33_i
iptables -F 172.16.0.33_o
iptables -A FORWARD -s 172.16.0.33 -j 172.16.0.33_o
iptables -A FORWARD -d 172.16.0.33 -j 172.16.0.33_i
iptables -A FORWARD -s 172.16.0.33 -m mac --mac-source 24:b6:fd:4d:ba:bc -j ACCEPT
iptables -A FORWARD -d 172.16.0.33 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2861 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:2861 classid 1:286a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:2861 classid 1:286b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 28601 fw classid 1:286a
tc filter add dev eth0 protocol ip parent 1: handle 28602 fw classid 1:286b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2860 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:2860 classid 1:286d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:2860 classid 1:286e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 28604 fw classid 1:286d
tc filter add dev eth1 protocol ip parent 1: handle 28605 fw classid 1:286e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.33 --set-mark 28602
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.33 --set-mark 28605

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.33 -p tcp --dport 22 --set-mark 28604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.33 -p tcp --sport 22 --set-mark 28601
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.33 -p udp --dport 53 --set-mark 28604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.33 -p udp --sport 53 --set-mark 28601
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.33 -p tcp --dport 80 --set-mark 28604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.33 -p tcp --sport 80 --set-mark 28601
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.33 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.33 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC41	IP:141    ID: 295
#------------------------------------------------------------------------------
iptables -X 172.16.0.141_i
iptables -X 172.16.0.141_o
iptables -N 172.16.0.141_i
iptables -N 172.16.0.141_o
iptables -F 172.16.0.141_i
iptables -F 172.16.0.141_o
iptables -A FORWARD -s 172.16.0.141 -j 172.16.0.141_o
iptables -A FORWARD -d 172.16.0.141 -j 172.16.0.141_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2951 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:2951 classid 1:295a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:2951 classid 1:295b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 29501 fw classid 1:295a
tc filter add dev eth0 protocol ip parent 1: handle 29502 fw classid 1:295b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2950 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:2950 classid 1:295d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:2950 classid 1:295e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 29504 fw classid 1:295d
tc filter add dev eth1 protocol ip parent 1: handle 29505 fw classid 1:295e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.141 --set-mark 29502
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.141 --set-mark 29505

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.141 -p tcp --dport 22 --set-mark 29504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.141 -p tcp --sport 22 --set-mark 29501
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.141 -p udp --dport 53 --set-mark 29504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.141 -p udp --sport 53 --set-mark 29501
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.141 -p tcp --dport 80 --set-mark 29504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.141 -p tcp --sport 80 --set-mark 29501
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.141 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.141 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC52	IP:55    ID: 298
#------------------------------------------------------------------------------
iptables -X 172.16.0.55_i
iptables -X 172.16.0.55_o
iptables -N 172.16.0.55_i
iptables -N 172.16.0.55_o
iptables -F 172.16.0.55_i
iptables -F 172.16.0.55_o
iptables -A FORWARD -s 172.16.0.55 -j 172.16.0.55_o
iptables -A FORWARD -d 172.16.0.55 -j 172.16.0.55_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:2981 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:2981 classid 1:298a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:2981 classid 1:298b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 29801 fw classid 1:298a
tc filter add dev eth0 protocol ip parent 1: handle 29802 fw classid 1:298b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:2980 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:2980 classid 1:298d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:2980 classid 1:298e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 29804 fw classid 1:298d
tc filter add dev eth1 protocol ip parent 1: handle 29805 fw classid 1:298e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.55 --set-mark 29802
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.55 --set-mark 29805

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.55 -p tcp --dport 22 --set-mark 29804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.55 -p tcp --sport 22 --set-mark 29801
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.55 -p udp --dport 53 --set-mark 29804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.55 -p udp --sport 53 --set-mark 29801
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.55 -p tcp --dport 80 --set-mark 29804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.55 -p tcp --sport 80 --set-mark 29801
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.55 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.55 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Mariela Rossetti	IP:73    ID: 323
#------------------------------------------------------------------------------
iptables -X 172.16.0.73_i
iptables -X 172.16.0.73_o
iptables -N 172.16.0.73_i
iptables -N 172.16.0.73_o
iptables -F 172.16.0.73_i
iptables -F 172.16.0.73_o
iptables -A FORWARD -s 172.16.0.73 -j 172.16.0.73_o
iptables -A FORWARD -d 172.16.0.73 -j 172.16.0.73_i
iptables -A FORWARD -s 172.16.0.73 -m mac --mac-source 00:1c:c0:37:40:b7 -j ACCEPT
iptables -A FORWARD -d 172.16.0.73 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:3231 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:3231 classid 1:323a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:3231 classid 1:323b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 32301 fw classid 1:323a
tc filter add dev eth0 protocol ip parent 1: handle 32302 fw classid 1:323b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:3230 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:3230 classid 1:323d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:3230 classid 1:323e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 32304 fw classid 1:323d
tc filter add dev eth1 protocol ip parent 1: handle 32305 fw classid 1:323e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.73 --set-mark 32302
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.73 --set-mark 32305

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.73 -p tcp --dport 22 --set-mark 32304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.73 -p tcp --sport 22 --set-mark 32301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.73 -p udp --dport 53 --set-mark 32304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.73 -p udp --sport 53 --set-mark 32301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.73 -p tcp --dport 80 --set-mark 32304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.73 -p tcp --sport 80 --set-mark 32301
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.73 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.73 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Controlador Fiscal 2	IP:67    ID: 330
#------------------------------------------------------------------------------
iptables -X 172.16.0.67_i
iptables -X 172.16.0.67_o
iptables -N 172.16.0.67_i
iptables -N 172.16.0.67_o
iptables -F 172.16.0.67_i
iptables -F 172.16.0.67_o
iptables -A FORWARD -s 172.16.0.67 -j 172.16.0.67_o
iptables -A FORWARD -d 172.16.0.67 -j 172.16.0.67_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:3301 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:3301 classid 1:330a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:3301 classid 1:330b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 33001 fw classid 1:330a
tc filter add dev eth0 protocol ip parent 1: handle 33002 fw classid 1:330b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:3300 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:3300 classid 1:330d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:3300 classid 1:330e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 33004 fw classid 1:330d
tc filter add dev eth1 protocol ip parent 1: handle 33005 fw classid 1:330e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.67 --set-mark 33002
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.67 --set-mark 33005

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.67 -p tcp --dport 22 --set-mark 33004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.67 -p tcp --sport 22 --set-mark 33001
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.67 -p udp --dport 53 --set-mark 33004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.67 -p udp --sport 53 --set-mark 33001
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.67 -p tcp --dport 80 --set-mark 33004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.67 -p tcp --sport 80 --set-mark 33001
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.67 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.67 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC48	IP:142    ID: 341
#------------------------------------------------------------------------------
iptables -X 172.16.0.142_i
iptables -X 172.16.0.142_o
iptables -N 172.16.0.142_i
iptables -N 172.16.0.142_o
iptables -F 172.16.0.142_i
iptables -F 172.16.0.142_o
iptables -A FORWARD -s 172.16.0.142 -j 172.16.0.142_o
iptables -A FORWARD -d 172.16.0.142 -j 172.16.0.142_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:3411 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:3411 classid 1:341a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:3411 classid 1:341b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 34101 fw classid 1:341a
tc filter add dev eth0 protocol ip parent 1: handle 34102 fw classid 1:341b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:3410 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:3410 classid 1:341d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:3410 classid 1:341e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 34104 fw classid 1:341d
tc filter add dev eth1 protocol ip parent 1: handle 34105 fw classid 1:341e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.142 --set-mark 34102
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.142 --set-mark 34105

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.142 -p tcp --dport 22 --set-mark 34104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.142 -p tcp --sport 22 --set-mark 34101
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.142 -p udp --dport 53 --set-mark 34104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.142 -p udp --sport 53 --set-mark 34101
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.142 -p tcp --dport 80 --set-mark 34104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.142 -p tcp --sport 80 --set-mark 34101
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.142 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.142 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC43	IP:143    ID: 343
#------------------------------------------------------------------------------
iptables -X 172.16.0.143_i
iptables -X 172.16.0.143_o
iptables -N 172.16.0.143_i
iptables -N 172.16.0.143_o
iptables -F 172.16.0.143_i
iptables -F 172.16.0.143_o
iptables -A FORWARD -s 172.16.0.143 -j 172.16.0.143_o
iptables -A FORWARD -d 172.16.0.143 -j 172.16.0.143_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:3431 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:3431 classid 1:343a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:3431 classid 1:343b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 34301 fw classid 1:343a
tc filter add dev eth0 protocol ip parent 1: handle 34302 fw classid 1:343b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:3430 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:3430 classid 1:343d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:3430 classid 1:343e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 34304 fw classid 1:343d
tc filter add dev eth1 protocol ip parent 1: handle 34305 fw classid 1:343e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.143 --set-mark 34302
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.143 --set-mark 34305

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.143 -p tcp --dport 22 --set-mark 34304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.143 -p tcp --sport 22 --set-mark 34301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.143 -p udp --dport 53 --set-mark 34304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.143 -p udp --sport 53 --set-mark 34301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.143 -p tcp --dport 80 --set-mark 34304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.143 -p tcp --sport 80 --set-mark 34301
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.143 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.143 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Sala de Reuniones	IP:80    ID: 348
#------------------------------------------------------------------------------
iptables -X 172.16.0.80_i
iptables -X 172.16.0.80_o
iptables -N 172.16.0.80_i
iptables -N 172.16.0.80_o
iptables -F 172.16.0.80_i
iptables -F 172.16.0.80_o
iptables -A FORWARD -s 172.16.0.80 -j 172.16.0.80_o
iptables -A FORWARD -d 172.16.0.80 -j 172.16.0.80_i
iptables -A FORWARD -s 172.16.0.80 -m mac --mac-source 00:0b:82:11:b9:2d -j ACCEPT
iptables -A FORWARD -d 172.16.0.80 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:3481 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:3481 classid 1:348a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:3481 classid 1:348b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 34801 fw classid 1:348a
tc filter add dev eth0 protocol ip parent 1: handle 34802 fw classid 1:348b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:3480 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:3480 classid 1:348d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:3480 classid 1:348e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 34804 fw classid 1:348d
tc filter add dev eth1 protocol ip parent 1: handle 34805 fw classid 1:348e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.80 --set-mark 34802
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.80 --set-mark 34805

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.80 -p tcp --dport 22 --set-mark 34804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.80 -p tcp --sport 22 --set-mark 34801
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.80 -p udp --dport 53 --set-mark 34804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.80 -p udp --sport 53 --set-mark 34801
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.80 -p tcp --dport 80 --set-mark 34804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.80 -p tcp --sport 80 --set-mark 34801
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.80 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.80 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC47	IP:151    ID: 353
#------------------------------------------------------------------------------
iptables -X 172.16.0.151_i
iptables -X 172.16.0.151_o
iptables -N 172.16.0.151_i
iptables -N 172.16.0.151_o
iptables -F 172.16.0.151_i
iptables -F 172.16.0.151_o
iptables -A FORWARD -s 172.16.0.151 -j 172.16.0.151_o
iptables -A FORWARD -d 172.16.0.151 -j 172.16.0.151_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:3531 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:3531 classid 1:353a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:3531 classid 1:353b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 35301 fw classid 1:353a
tc filter add dev eth0 protocol ip parent 1: handle 35302 fw classid 1:353b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:3530 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:3530 classid 1:353d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:3530 classid 1:353e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 35304 fw classid 1:353d
tc filter add dev eth1 protocol ip parent 1: handle 35305 fw classid 1:353e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.151 --set-mark 35302
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.151 --set-mark 35305

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.151 -p tcp --dport 22 --set-mark 35304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.151 -p tcp --sport 22 --set-mark 35301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.151 -p udp --dport 53 --set-mark 35304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.151 -p udp --sport 53 --set-mark 35301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.151 -p tcp --dport 80 --set-mark 35304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.151 -p tcp --sport 80 --set-mark 35301
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.151 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.151 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Alejandro Rogers	IP:62    ID: 358
#------------------------------------------------------------------------------
iptables -X 172.16.0.62_i
iptables -X 172.16.0.62_o
iptables -N 172.16.0.62_i
iptables -N 172.16.0.62_o
iptables -F 172.16.0.62_i
iptables -F 172.16.0.62_o
iptables -A FORWARD -s 172.16.0.62 -j 172.16.0.62_o
iptables -A FORWARD -d 172.16.0.62 -j 172.16.0.62_i
iptables -A FORWARD -s 172.16.0.62 -m mac --mac-source f0:de:f1:87:cb:2c -j ACCEPT
iptables -A FORWARD -d 172.16.0.62 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:3581 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:3581 classid 1:358a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:3581 classid 1:358b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 35801 fw classid 1:358a
tc filter add dev eth0 protocol ip parent 1: handle 35802 fw classid 1:358b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:3580 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:3580 classid 1:358d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:3580 classid 1:358e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 35804 fw classid 1:358d
tc filter add dev eth1 protocol ip parent 1: handle 35805 fw classid 1:358e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.62 --set-mark 35802
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.62 --set-mark 35805

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.62 -p tcp --dport 22 --set-mark 35804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.62 -p tcp --sport 22 --set-mark 35801
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.62 -p udp --dport 53 --set-mark 35804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.62 -p udp --sport 53 --set-mark 35801
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.62 -p tcp --dport 80 --set-mark 35804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.62 -p tcp --sport 80 --set-mark 35801
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.62 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.62 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC45	IP:145    ID: 365
#------------------------------------------------------------------------------
iptables -X 172.16.0.145_i
iptables -X 172.16.0.145_o
iptables -N 172.16.0.145_i
iptables -N 172.16.0.145_o
iptables -F 172.16.0.145_i
iptables -F 172.16.0.145_o
iptables -A FORWARD -s 172.16.0.145 -j 172.16.0.145_o
iptables -A FORWARD -d 172.16.0.145 -j 172.16.0.145_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:3651 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:3651 classid 1:365a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:3651 classid 1:365b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 36501 fw classid 1:365a
tc filter add dev eth0 protocol ip parent 1: handle 36502 fw classid 1:365b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:3650 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:3650 classid 1:365d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:3650 classid 1:365e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 36504 fw classid 1:365d
tc filter add dev eth1 protocol ip parent 1: handle 36505 fw classid 1:365e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.145 --set-mark 36502
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.145 --set-mark 36505

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.145 -p tcp --dport 22 --set-mark 36504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.145 -p tcp --sport 22 --set-mark 36501
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.145 -p udp --dport 53 --set-mark 36504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.145 -p udp --sport 53 --set-mark 36501
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.145 -p tcp --dport 80 --set-mark 36504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.145 -p tcp --sport 80 --set-mark 36501
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.145 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.145 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Notebook M. Gaitto	IP:14    ID: 446
#------------------------------------------------------------------------------
iptables -X 172.16.0.14_i
iptables -X 172.16.0.14_o
iptables -N 172.16.0.14_i
iptables -N 172.16.0.14_o
iptables -F 172.16.0.14_i
iptables -F 172.16.0.14_o
iptables -A FORWARD -s 172.16.0.14 -j 172.16.0.14_o
iptables -A FORWARD -d 172.16.0.14 -j 172.16.0.14_i
iptables -A FORWARD -s 172.16.0.14 -m mac --mac-source 00:21:6b:ca:89:d0 -j ACCEPT
iptables -A FORWARD -d 172.16.0.14 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4461 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:4461 classid 1:446a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:4461 classid 1:446b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 44601 fw classid 1:446a
tc filter add dev eth0 protocol ip parent 1: handle 44602 fw classid 1:446b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4460 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:4460 classid 1:446d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:4460 classid 1:446e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 44604 fw classid 1:446d
tc filter add dev eth1 protocol ip parent 1: handle 44605 fw classid 1:446e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.14 --set-mark 44602
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.14 --set-mark 44605

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.14 -p tcp --dport 22 --set-mark 44604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.14 -p tcp --sport 22 --set-mark 44601
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.14 -p udp --dport 53 --set-mark 44604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.14 -p udp --sport 53 --set-mark 44601
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.14 -p tcp --dport 80 --set-mark 44604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.14 -p tcp --sport 80 --set-mark 44601
iptables -t nat -A POSTROUTING -s 172.16.0.14 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC42	IP:42    ID: 394
#------------------------------------------------------------------------------
iptables -X 172.16.0.42_i
iptables -X 172.16.0.42_o
iptables -N 172.16.0.42_i
iptables -N 172.16.0.42_o
iptables -F 172.16.0.42_i
iptables -F 172.16.0.42_o
iptables -A FORWARD -s 172.16.0.42 -j 172.16.0.42_o
iptables -A FORWARD -d 172.16.0.42 -j 172.16.0.42_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:3941 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:3941 classid 1:394a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:3941 classid 1:394b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 39401 fw classid 1:394a
tc filter add dev eth0 protocol ip parent 1: handle 39402 fw classid 1:394b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:3940 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:3940 classid 1:394d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:3940 classid 1:394e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 39404 fw classid 1:394d
tc filter add dev eth1 protocol ip parent 1: handle 39405 fw classid 1:394e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.42 --set-mark 39402
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.42 --set-mark 39405

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.42 -p tcp --dport 22 --set-mark 39404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.42 -p tcp --sport 22 --set-mark 39401
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.42 -p udp --dport 53 --set-mark 39404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.42 -p udp --sport 53 --set-mark 39401
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.42 -p tcp --dport 80 --set-mark 39404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.42 -p tcp --sport 80 --set-mark 39401
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.42 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.42 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Erica Mirkouski	IP:61    ID: 374
#------------------------------------------------------------------------------
iptables -X 172.16.0.61_i
iptables -X 172.16.0.61_o
iptables -N 172.16.0.61_i
iptables -N 172.16.0.61_o
iptables -F 172.16.0.61_i
iptables -F 172.16.0.61_o
iptables -A FORWARD -s 172.16.0.61 -j 172.16.0.61_o
iptables -A FORWARD -d 172.16.0.61 -j 172.16.0.61_i
iptables -A FORWARD -s 172.16.0.61 -m mac --mac-source 00:27:0e:15:9d:38 -j ACCEPT
iptables -A FORWARD -d 172.16.0.61 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:3741 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:3741 classid 1:374a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:3741 classid 1:374b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 37401 fw classid 1:374a
tc filter add dev eth0 protocol ip parent 1: handle 37402 fw classid 1:374b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:3740 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:3740 classid 1:374d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:3740 classid 1:374e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 37404 fw classid 1:374d
tc filter add dev eth1 protocol ip parent 1: handle 37405 fw classid 1:374e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.61 --set-mark 37402
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.61 --set-mark 37405

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.61 -p tcp --dport 22 --set-mark 37404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.61 -p tcp --sport 22 --set-mark 37401
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.61 -p udp --dport 53 --set-mark 37404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.61 -p udp --sport 53 --set-mark 37401
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.61 -p tcp --dport 80 --set-mark 37404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.61 -p tcp --sport 80 --set-mark 37401
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.61 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.61 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Manuela Gaitto	IP:49    ID: 412
#------------------------------------------------------------------------------
iptables -X 172.16.0.49_i
iptables -X 172.16.0.49_o
iptables -N 172.16.0.49_i
iptables -N 172.16.0.49_o
iptables -F 172.16.0.49_i
iptables -F 172.16.0.49_o
iptables -A FORWARD -s 172.16.0.49 -j 172.16.0.49_o
iptables -A FORWARD -d 172.16.0.49 -j 172.16.0.49_i
iptables -A FORWARD -s 172.16.0.49 -m mac --mac-source 78:dd:08:e0:20:c6 -j ACCEPT
iptables -A FORWARD -d 172.16.0.49 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4121 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:4121 classid 1:412a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:4121 classid 1:412b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 41201 fw classid 1:412a
tc filter add dev eth0 protocol ip parent 1: handle 41202 fw classid 1:412b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4120 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:4120 classid 1:412d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:4120 classid 1:412e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 41204 fw classid 1:412d
tc filter add dev eth1 protocol ip parent 1: handle 41205 fw classid 1:412e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.49 --set-mark 41202
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.49 --set-mark 41205

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.49 -p tcp --dport 22 --set-mark 41204
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.49 -p tcp --sport 22 --set-mark 41201
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.49 -p udp --dport 53 --set-mark 41204
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.49 -p udp --sport 53 --set-mark 41201
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.49 -p tcp --dport 80 --set-mark 41204
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.49 -p tcp --sport 80 --set-mark 41201
iptables -t nat -A POSTROUTING -s 172.16.0.49 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Zafiro Backup	IP:13    ID: 375
#------------------------------------------------------------------------------
iptables -X 172.16.0.13_i
iptables -X 172.16.0.13_o
iptables -N 172.16.0.13_i
iptables -N 172.16.0.13_o
iptables -F 172.16.0.13_i
iptables -F 172.16.0.13_o
iptables -A FORWARD -s 172.16.0.13 -j 172.16.0.13_o
iptables -A FORWARD -d 172.16.0.13 -j 172.16.0.13_i
iptables -A FORWARD -s 172.16.0.13 -m mac --mac-source 00:19:21:19:3d:7e -j ACCEPT
iptables -A FORWARD -d 172.16.0.13 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:3751 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:3751 classid 1:375a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:3751 classid 1:375b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 37501 fw classid 1:375a
tc filter add dev eth0 protocol ip parent 1: handle 37502 fw classid 1:375b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:3750 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:3750 classid 1:375d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:3750 classid 1:375e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 37504 fw classid 1:375d
tc filter add dev eth1 protocol ip parent 1: handle 37505 fw classid 1:375e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.13 --set-mark 37502
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.13 --set-mark 37505

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.13 -p tcp --dport 22 --set-mark 37504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.13 -p tcp --sport 22 --set-mark 37501
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.13 -p udp --dport 53 --set-mark 37504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.13 -p udp --sport 53 --set-mark 37501
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.13 -p tcp --dport 80 --set-mark 37504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.13 -p tcp --sport 80 --set-mark 37501
iptables -t nat -A POSTROUTING -s 172.16.0.13 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Dan Wyrytowski	IP:26    ID: 414
#------------------------------------------------------------------------------
iptables -X 172.16.0.26_i
iptables -X 172.16.0.26_o
iptables -N 172.16.0.26_i
iptables -N 172.16.0.26_o
iptables -F 172.16.0.26_i
iptables -F 172.16.0.26_o
iptables -A FORWARD -s 172.16.0.26 -j 172.16.0.26_o
iptables -A FORWARD -d 172.16.0.26 -j 172.16.0.26_i
iptables -A FORWARD -s 172.16.0.26 -m mac --mac-source e4:d5:3d:12:3a:db -j ACCEPT
iptables -A FORWARD -d 172.16.0.26 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4141 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:4141 classid 1:414a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:4141 classid 1:414b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 41401 fw classid 1:414a
tc filter add dev eth0 protocol ip parent 1: handle 41402 fw classid 1:414b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4140 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:4140 classid 1:414d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:4140 classid 1:414e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 41404 fw classid 1:414d
tc filter add dev eth1 protocol ip parent 1: handle 41405 fw classid 1:414e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.26 --set-mark 41402
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.26 --set-mark 41405

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.26 -p tcp --dport 22 --set-mark 41404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.26 -p tcp --sport 22 --set-mark 41401
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.26 -p udp --dport 53 --set-mark 41404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.26 -p udp --sport 53 --set-mark 41401
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.26 -p tcp --dport 80 --set-mark 41404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.26 -p tcp --sport 80 --set-mark 41401
iptables -t nat -A POSTROUTING -s 172.16.0.26 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Dario Juarez	IP:24    ID: 379
#------------------------------------------------------------------------------
iptables -X 172.16.0.24_i
iptables -X 172.16.0.24_o
iptables -N 172.16.0.24_i
iptables -N 172.16.0.24_o
iptables -F 172.16.0.24_i
iptables -F 172.16.0.24_o
iptables -A FORWARD -s 172.16.0.24 -j 172.16.0.24_o
iptables -A FORWARD -d 172.16.0.24 -j 172.16.0.24_i
iptables -A FORWARD -s 172.16.0.24 -m mac --mac-source 48:5d:60:dc:7d:37 -j ACCEPT
iptables -A FORWARD -d 172.16.0.24 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:3791 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:3791 classid 1:379a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:3791 classid 1:379b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 37901 fw classid 1:379a
tc filter add dev eth0 protocol ip parent 1: handle 37902 fw classid 1:379b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:3790 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:3790 classid 1:379d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:3790 classid 1:379e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 37904 fw classid 1:379d
tc filter add dev eth1 protocol ip parent 1: handle 37905 fw classid 1:379e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.24 --set-mark 37902
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.24 --set-mark 37905

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.24 -p tcp --dport 22 --set-mark 37904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.24 -p tcp --sport 22 --set-mark 37901
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.24 -p udp --dport 53 --set-mark 37904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.24 -p udp --sport 53 --set-mark 37901
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.24 -p tcp --dport 80 --set-mark 37904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.24 -p tcp --sport 80 --set-mark 37901
iptables -t nat -A POSTROUTING -s 172.16.0.24 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC46	IP:146    ID: 384
#------------------------------------------------------------------------------
iptables -X 172.16.0.146_i
iptables -X 172.16.0.146_o
iptables -N 172.16.0.146_i
iptables -N 172.16.0.146_o
iptables -F 172.16.0.146_i
iptables -F 172.16.0.146_o
iptables -A FORWARD -s 172.16.0.146 -j 172.16.0.146_o
iptables -A FORWARD -d 172.16.0.146 -j 172.16.0.146_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:3841 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:3841 classid 1:384a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:3841 classid 1:384b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 38401 fw classid 1:384a
tc filter add dev eth0 protocol ip parent 1: handle 38402 fw classid 1:384b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:3840 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:3840 classid 1:384d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:3840 classid 1:384e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 38404 fw classid 1:384d
tc filter add dev eth1 protocol ip parent 1: handle 38405 fw classid 1:384e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.146 --set-mark 38402
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.146 --set-mark 38405

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.146 -p tcp --dport 22 --set-mark 38404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.146 -p tcp --sport 22 --set-mark 38401
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.146 -p udp --dport 53 --set-mark 38404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.146 -p udp --sport 53 --set-mark 38401
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.146 -p tcp --dport 80 --set-mark 38404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.146 -p tcp --sport 80 --set-mark 38401
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.146 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.146 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Asesora Vicente Lopez	IP:18    ID: 395
#------------------------------------------------------------------------------
iptables -X 172.16.0.18_i
iptables -X 172.16.0.18_o
iptables -N 172.16.0.18_i
iptables -N 172.16.0.18_o
iptables -F 172.16.0.18_i
iptables -F 172.16.0.18_o
iptables -A FORWARD -s 172.16.0.18 -j 172.16.0.18_o
iptables -A FORWARD -d 172.16.0.18 -j 172.16.0.18_i
iptables -A FORWARD -s 172.16.0.18 -m mac --mac-source 00:26:82:05:cd:35 -j ACCEPT
iptables -A FORWARD -d 172.16.0.18 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:3951 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:3951 classid 1:395a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:3951 classid 1:395b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 39501 fw classid 1:395a
tc filter add dev eth0 protocol ip parent 1: handle 39502 fw classid 1:395b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:3950 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:3950 classid 1:395d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:3950 classid 1:395e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 39504 fw classid 1:395d
tc filter add dev eth1 protocol ip parent 1: handle 39505 fw classid 1:395e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.18 --set-mark 39502
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.18 --set-mark 39505

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.18 -p tcp --dport 22 --set-mark 39504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.18 -p tcp --sport 22 --set-mark 39501
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.18 -p udp --dport 53 --set-mark 39504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.18 -p udp --sport 53 --set-mark 39501
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.18 -p tcp --dport 80 --set-mark 39504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.18 -p tcp --sport 80 --set-mark 39501
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.18 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.18 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Manuela Gaitto	IP:82    ID: 389
#------------------------------------------------------------------------------
iptables -X 172.16.0.82_i
iptables -X 172.16.0.82_o
iptables -N 172.16.0.82_i
iptables -N 172.16.0.82_o
iptables -F 172.16.0.82_i
iptables -F 172.16.0.82_o
iptables -A FORWARD -s 172.16.0.82 -j 172.16.0.82_o
iptables -A FORWARD -d 172.16.0.82 -j 172.16.0.82_i
iptables -A FORWARD -s 172.16.0.82 -m mac --mac-source 80:c1:6e:59:1b:df -j ACCEPT
iptables -A FORWARD -d 172.16.0.82 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:3891 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:3891 classid 1:389a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:3891 classid 1:389b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 38901 fw classid 1:389a
tc filter add dev eth0 protocol ip parent 1: handle 38902 fw classid 1:389b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:3890 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:3890 classid 1:389d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:3890 classid 1:389e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 38904 fw classid 1:389d
tc filter add dev eth1 protocol ip parent 1: handle 38905 fw classid 1:389e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.82 --set-mark 38902
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.82 --set-mark 38905

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.82 -p tcp --dport 22 --set-mark 38904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.82 -p tcp --sport 22 --set-mark 38901
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.82 -p udp --dport 53 --set-mark 38904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.82 -p udp --sport 53 --set-mark 38901
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.82 -p tcp --dport 80 --set-mark 38904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.82 -p tcp --sport 80 --set-mark 38901
iptables -t nat -A POSTROUTING -s 172.16.0.82 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Impresora Reuniones	IP:30    ID: 390
#------------------------------------------------------------------------------
iptables -X 172.16.0.30_i
iptables -X 172.16.0.30_o
iptables -N 172.16.0.30_i
iptables -N 172.16.0.30_o
iptables -F 172.16.0.30_i
iptables -F 172.16.0.30_o
iptables -A FORWARD -s 172.16.0.30 -j 172.16.0.30_o
iptables -A FORWARD -d 172.16.0.30 -j 172.16.0.30_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:3901 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:3901 classid 1:390a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:3901 classid 1:390b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 39001 fw classid 1:390a
tc filter add dev eth0 protocol ip parent 1: handle 39002 fw classid 1:390b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:3900 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:3900 classid 1:390d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:3900 classid 1:390e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 39004 fw classid 1:390d
tc filter add dev eth1 protocol ip parent 1: handle 39005 fw classid 1:390e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.30 --set-mark 39002
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.30 --set-mark 39005

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.30 -p tcp --dport 22 --set-mark 39004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.30 -p tcp --sport 22 --set-mark 39001
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.30 -p udp --dport 53 --set-mark 39004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.30 -p udp --sport 53 --set-mark 39001
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.30 -p tcp --dport 80 --set-mark 39004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.30 -p tcp --sport 80 --set-mark 39001
iptables -t nat -A POSTROUTING -s 172.16.0.30 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Asesora Lucia Barrios	IP:70    ID: 392
#------------------------------------------------------------------------------
iptables -X 172.16.0.70_i
iptables -X 172.16.0.70_o
iptables -N 172.16.0.70_i
iptables -N 172.16.0.70_o
iptables -F 172.16.0.70_i
iptables -F 172.16.0.70_o
iptables -A FORWARD -s 172.16.0.70 -j 172.16.0.70_o
iptables -A FORWARD -d 172.16.0.70 -j 172.16.0.70_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:3921 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:3921 classid 1:392a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:3921 classid 1:392b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 39201 fw classid 1:392a
tc filter add dev eth0 protocol ip parent 1: handle 39202 fw classid 1:392b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:3920 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:3920 classid 1:392d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:3920 classid 1:392e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 39204 fw classid 1:392d
tc filter add dev eth1 protocol ip parent 1: handle 39205 fw classid 1:392e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.70 --set-mark 39202
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.70 --set-mark 39205

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.70 -p tcp --dport 22 --set-mark 39204
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.70 -p tcp --sport 22 --set-mark 39201
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.70 -p udp --dport 53 --set-mark 39204
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.70 -p udp --sport 53 --set-mark 39201
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.70 -p tcp --dport 80 --set-mark 39204
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.70 -p tcp --sport 80 --set-mark 39201
iptables -t nat -A POSTROUTING -s 172.16.0.70 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Pablo Arambarri	IP:38    ID: 396
#------------------------------------------------------------------------------
iptables -X 172.16.0.38_i
iptables -X 172.16.0.38_o
iptables -N 172.16.0.38_i
iptables -N 172.16.0.38_o
iptables -F 172.16.0.38_i
iptables -F 172.16.0.38_o
iptables -A FORWARD -s 172.16.0.38 -j 172.16.0.38_o
iptables -A FORWARD -d 172.16.0.38 -j 172.16.0.38_i
iptables -A FORWARD -s 172.16.0.38 -m mac --mac-source 78:e4:00:d3:ee:d5 -j ACCEPT
iptables -A FORWARD -d 172.16.0.38 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:3961 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:3961 classid 1:396a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:3961 classid 1:396b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 39601 fw classid 1:396a
tc filter add dev eth0 protocol ip parent 1: handle 39602 fw classid 1:396b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:3960 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:3960 classid 1:396d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:3960 classid 1:396e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 39604 fw classid 1:396d
tc filter add dev eth1 protocol ip parent 1: handle 39605 fw classid 1:396e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.38 --set-mark 39602
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.38 --set-mark 39605

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.38 -p tcp --dport 22 --set-mark 39604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.38 -p tcp --sport 22 --set-mark 39601
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.38 -p udp --dport 53 --set-mark 39604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.38 -p udp --sport 53 --set-mark 39601
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.38 -p tcp --dport 80 --set-mark 39604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.38 -p tcp --sport 80 --set-mark 39601
iptables -t nat -A POSTROUTING -s 172.16.0.38 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC24	IP:152    ID: 398
#------------------------------------------------------------------------------
iptables -X 172.16.0.152_i
iptables -X 172.16.0.152_o
iptables -N 172.16.0.152_i
iptables -N 172.16.0.152_o
iptables -F 172.16.0.152_i
iptables -F 172.16.0.152_o
iptables -A FORWARD -s 172.16.0.152 -j 172.16.0.152_o
iptables -A FORWARD -d 172.16.0.152 -j 172.16.0.152_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:3981 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:3981 classid 1:398a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:3981 classid 1:398b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 39801 fw classid 1:398a
tc filter add dev eth0 protocol ip parent 1: handle 39802 fw classid 1:398b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:3980 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:3980 classid 1:398d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:3980 classid 1:398e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 39804 fw classid 1:398d
tc filter add dev eth1 protocol ip parent 1: handle 39805 fw classid 1:398e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.152 --set-mark 39802
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.152 --set-mark 39805

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.152 -p tcp --dport 22 --set-mark 39804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.152 -p tcp --sport 22 --set-mark 39801
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.152 -p udp --dport 53 --set-mark 39804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.152 -p udp --sport 53 --set-mark 39801
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.152 -p tcp --dport 80 --set-mark 39804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.152 -p tcp --sport 80 --set-mark 39801
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.152 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.152 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - HPDESKJET3050	IP:32    ID: 400
#------------------------------------------------------------------------------
iptables -X 172.16.0.32_i
iptables -X 172.16.0.32_o
iptables -N 172.16.0.32_i
iptables -N 172.16.0.32_o
iptables -F 172.16.0.32_i
iptables -F 172.16.0.32_o
iptables -A FORWARD -s 172.16.0.32 -j 172.16.0.32_o
iptables -A FORWARD -d 172.16.0.32 -j 172.16.0.32_i
iptables -A FORWARD -s 172.16.0.32 -m mac --mac-source 28:92:4a:a6:11:7a -j ACCEPT
iptables -A FORWARD -d 172.16.0.32 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4001 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:4001 classid 1:400a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:4001 classid 1:400b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 40001 fw classid 1:400a
tc filter add dev eth0 protocol ip parent 1: handle 40002 fw classid 1:400b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4000 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:4000 classid 1:400d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:4000 classid 1:400e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 40004 fw classid 1:400d
tc filter add dev eth1 protocol ip parent 1: handle 40005 fw classid 1:400e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.32 --set-mark 40002
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.32 --set-mark 40005

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.32 -p tcp --dport 22 --set-mark 40004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.32 -p tcp --sport 22 --set-mark 40001
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.32 -p udp --dport 53 --set-mark 40004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.32 -p udp --sport 53 --set-mark 40001
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.32 -p tcp --dport 80 --set-mark 40004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.32 -p tcp --sport 80 --set-mark 40001
iptables -t nat -A POSTROUTING -s 172.16.0.32 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC ONELL CAMARAS	IP:35    ID: 402
#------------------------------------------------------------------------------
iptables -X 172.16.0.35_i
iptables -X 172.16.0.35_o
iptables -N 172.16.0.35_i
iptables -N 172.16.0.35_o
iptables -F 172.16.0.35_i
iptables -F 172.16.0.35_o
iptables -A FORWARD -s 172.16.0.35 -j 172.16.0.35_o
iptables -A FORWARD -d 172.16.0.35 -j 172.16.0.35_i
iptables -A FORWARD -s 172.16.0.35 -m mac --mac-source 00:27:0e:1c:28:ac -j ACCEPT
iptables -A FORWARD -d 172.16.0.35 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4021 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:4021 classid 1:402a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:4021 classid 1:402b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 40201 fw classid 1:402a
tc filter add dev eth0 protocol ip parent 1: handle 40202 fw classid 1:402b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4020 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:4020 classid 1:402d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:4020 classid 1:402e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 40204 fw classid 1:402d
tc filter add dev eth1 protocol ip parent 1: handle 40205 fw classid 1:402e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.35 --set-mark 40202
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.35 --set-mark 40205

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.35 -p tcp --dport 22 --set-mark 40204
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.35 -p tcp --sport 22 --set-mark 40201
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.35 -p udp --dport 53 --set-mark 40204
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.35 -p udp --sport 53 --set-mark 40201
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.35 -p tcp --dport 80 --set-mark 40204
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.35 -p tcp --sport 80 --set-mark 40201
iptables -t nat -A POSTROUTING -s 172.16.0.35 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Onell Lanfranco	IP:39    ID: 403
#------------------------------------------------------------------------------
iptables -X 172.16.0.39_i
iptables -X 172.16.0.39_o
iptables -N 172.16.0.39_i
iptables -N 172.16.0.39_o
iptables -F 172.16.0.39_i
iptables -F 172.16.0.39_o
iptables -A FORWARD -s 172.16.0.39 -j 172.16.0.39_o
iptables -A FORWARD -d 172.16.0.39 -j 172.16.0.39_i
iptables -A FORWARD -s 172.16.0.39 -m mac --mac-source 4c:8d:79:e9:51:36 -j ACCEPT
iptables -A FORWARD -d 172.16.0.39 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4031 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:4031 classid 1:403a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:4031 classid 1:403b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 40301 fw classid 1:403a
tc filter add dev eth0 protocol ip parent 1: handle 40302 fw classid 1:403b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4030 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:4030 classid 1:403d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:4030 classid 1:403e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 40304 fw classid 1:403d
tc filter add dev eth1 protocol ip parent 1: handle 40305 fw classid 1:403e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.39 --set-mark 40302
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.39 --set-mark 40305

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.39 -p tcp --dport 22 --set-mark 40304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.39 -p tcp --sport 22 --set-mark 40301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.39 -p udp --dport 53 --set-mark 40304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.39 -p udp --sport 53 --set-mark 40301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.39 -p tcp --dport 80 --set-mark 40304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.39 -p tcp --sport 80 --set-mark 40301
iptables -t nat -A POSTROUTING -s 172.16.0.39 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Cinthia Cabrino	IP:45    ID: 404
#------------------------------------------------------------------------------
iptables -X 172.16.0.45_i
iptables -X 172.16.0.45_o
iptables -N 172.16.0.45_i
iptables -N 172.16.0.45_o
iptables -F 172.16.0.45_i
iptables -F 172.16.0.45_o
iptables -A FORWARD -s 172.16.0.45 -j 172.16.0.45_o
iptables -A FORWARD -d 172.16.0.45 -j 172.16.0.45_i
iptables -A FORWARD -s 172.16.0.45 -m mac --mac-source 00:0d:28:8f:9e:6f -j ACCEPT
iptables -A FORWARD -d 172.16.0.45 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4041 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:4041 classid 1:404a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:4041 classid 1:404b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 40401 fw classid 1:404a
tc filter add dev eth0 protocol ip parent 1: handle 40402 fw classid 1:404b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4040 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:4040 classid 1:404d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:4040 classid 1:404e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 40404 fw classid 1:404d
tc filter add dev eth1 protocol ip parent 1: handle 40405 fw classid 1:404e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.45 --set-mark 40402
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.45 --set-mark 40405

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.45 -p tcp --dport 22 --set-mark 40404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.45 -p tcp --sport 22 --set-mark 40401
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.45 -p udp --dport 53 --set-mark 40404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.45 -p udp --sport 53 --set-mark 40401
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.45 -p tcp --dport 80 --set-mark 40404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.45 -p tcp --sport 80 --set-mark 40401
iptables -t nat -A POSTROUTING -s 172.16.0.45 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Onell Lanfranco	IP:44    ID: 405
#------------------------------------------------------------------------------
iptables -X 172.16.0.44_i
iptables -X 172.16.0.44_o
iptables -N 172.16.0.44_i
iptables -N 172.16.0.44_o
iptables -F 172.16.0.44_i
iptables -F 172.16.0.44_o
iptables -A FORWARD -s 172.16.0.44 -j 172.16.0.44_o
iptables -A FORWARD -d 172.16.0.44 -j 172.16.0.44_i
iptables -A FORWARD -s 172.16.0.44 -m mac --mac-source 00:80:f0:d1:ce:23 -j ACCEPT
iptables -A FORWARD -d 172.16.0.44 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4051 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:4051 classid 1:405a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:4051 classid 1:405b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 40501 fw classid 1:405a
tc filter add dev eth0 protocol ip parent 1: handle 40502 fw classid 1:405b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4050 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:4050 classid 1:405d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:4050 classid 1:405e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 40504 fw classid 1:405d
tc filter add dev eth1 protocol ip parent 1: handle 40505 fw classid 1:405e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.44 --set-mark 40502
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.44 --set-mark 40505

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.44 -p tcp --dport 22 --set-mark 40504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.44 -p tcp --sport 22 --set-mark 40501
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.44 -p udp --dport 53 --set-mark 40504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.44 -p udp --sport 53 --set-mark 40501
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.44 -p tcp --dport 80 --set-mark 40504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.44 -p tcp --sport 80 --set-mark 40501
iptables -t nat -A POSTROUTING -s 172.16.0.44 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Dario Juarez	IP:126    ID: 406
#------------------------------------------------------------------------------
iptables -X 172.16.0.126_i
iptables -X 172.16.0.126_o
iptables -N 172.16.0.126_i
iptables -N 172.16.0.126_o
iptables -F 172.16.0.126_i
iptables -F 172.16.0.126_o
iptables -A FORWARD -s 172.16.0.126 -j 172.16.0.126_o
iptables -A FORWARD -d 172.16.0.126 -j 172.16.0.126_i
iptables -A FORWARD -s 172.16.0.126 -m mac --mac-source 00:80:f0:d1:cd:dc -j ACCEPT
iptables -A FORWARD -d 172.16.0.126 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4061 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:4061 classid 1:406a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:4061 classid 1:406b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 40601 fw classid 1:406a
tc filter add dev eth0 protocol ip parent 1: handle 40602 fw classid 1:406b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4060 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:4060 classid 1:406d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:4060 classid 1:406e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 40604 fw classid 1:406d
tc filter add dev eth1 protocol ip parent 1: handle 40605 fw classid 1:406e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.126 --set-mark 40602
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.126 --set-mark 40605

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.126 -p tcp --dport 22 --set-mark 40604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.126 -p tcp --sport 22 --set-mark 40601
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.126 -p udp --dport 53 --set-mark 40604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.126 -p udp --sport 53 --set-mark 40601
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.126 -p tcp --dport 80 --set-mark 40604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.126 -p tcp --sport 80 --set-mark 40601
iptables -t nat -A POSTROUTING -s 172.16.0.126 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Pablo Arambarri	IP:147    ID: 408
#------------------------------------------------------------------------------
iptables -X 172.16.0.147_i
iptables -X 172.16.0.147_o
iptables -N 172.16.0.147_i
iptables -N 172.16.0.147_o
iptables -F 172.16.0.147_i
iptables -F 172.16.0.147_o
iptables -A FORWARD -s 172.16.0.147 -j 172.16.0.147_o
iptables -A FORWARD -d 172.16.0.147 -j 172.16.0.147_i
iptables -A FORWARD -s 172.16.0.147 -m mac --mac-source 00:80:f0:d1:d5:4e -j ACCEPT
iptables -A FORWARD -d 172.16.0.147 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4081 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:4081 classid 1:408a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:4081 classid 1:408b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 40801 fw classid 1:408a
tc filter add dev eth0 protocol ip parent 1: handle 40802 fw classid 1:408b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4080 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:4080 classid 1:408d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:4080 classid 1:408e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 40804 fw classid 1:408d
tc filter add dev eth1 protocol ip parent 1: handle 40805 fw classid 1:408e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.147 --set-mark 40802
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.147 --set-mark 40805

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.147 -p tcp --dport 22 --set-mark 40804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.147 -p tcp --sport 22 --set-mark 40801
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.147 -p udp --dport 53 --set-mark 40804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.147 -p udp --sport 53 --set-mark 40801
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.147 -p tcp --dport 80 --set-mark 40804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.147 -p tcp --sport 80 --set-mark 40801
iptables -t nat -A POSTROUTING -s 172.16.0.147 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Vicente Lpez Recepcin	IP:148    ID: 409
#------------------------------------------------------------------------------
iptables -X 172.16.0.148_i
iptables -X 172.16.0.148_o
iptables -N 172.16.0.148_i
iptables -N 172.16.0.148_o
iptables -F 172.16.0.148_i
iptables -F 172.16.0.148_o
iptables -A FORWARD -s 172.16.0.148 -j 172.16.0.148_o
iptables -A FORWARD -d 172.16.0.148 -j 172.16.0.148_i
iptables -A FORWARD -s 172.16.0.148 -m mac --mac-source 00:80:f0:d1:d5:46 -j ACCEPT
iptables -A FORWARD -d 172.16.0.148 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4091 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:4091 classid 1:409a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:4091 classid 1:409b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 40901 fw classid 1:409a
tc filter add dev eth0 protocol ip parent 1: handle 40902 fw classid 1:409b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4090 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:4090 classid 1:409d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:4090 classid 1:409e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 40904 fw classid 1:409d
tc filter add dev eth1 protocol ip parent 1: handle 40905 fw classid 1:409e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.148 --set-mark 40902
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.148 --set-mark 40905

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.148 -p tcp --dport 22 --set-mark 40904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.148 -p tcp --sport 22 --set-mark 40901
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.148 -p udp --dport 53 --set-mark 40904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.148 -p udp --sport 53 --set-mark 40901
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.148 -p tcp --dport 80 --set-mark 40904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.148 -p tcp --sport 80 --set-mark 40901
iptables -t nat -A POSTROUTING -s 172.16.0.148 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Erica Mirkouski	IP:149    ID: 410
#------------------------------------------------------------------------------
iptables -X 172.16.0.149_i
iptables -X 172.16.0.149_o
iptables -N 172.16.0.149_i
iptables -N 172.16.0.149_o
iptables -F 172.16.0.149_i
iptables -F 172.16.0.149_o
iptables -A FORWARD -s 172.16.0.149 -j 172.16.0.149_o
iptables -A FORWARD -d 172.16.0.149 -j 172.16.0.149_i
iptables -A FORWARD -s 172.16.0.149 -m mac --mac-source 00:80:f0:d1:d1:9f -j ACCEPT
iptables -A FORWARD -d 172.16.0.149 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4101 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:4101 classid 1:410a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:4101 classid 1:410b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 41001 fw classid 1:410a
tc filter add dev eth0 protocol ip parent 1: handle 41002 fw classid 1:410b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4100 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:4100 classid 1:410d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:4100 classid 1:410e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 41004 fw classid 1:410d
tc filter add dev eth1 protocol ip parent 1: handle 41005 fw classid 1:410e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.149 --set-mark 41002
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.149 --set-mark 41005

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.149 -p tcp --dport 22 --set-mark 41004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.149 -p tcp --sport 22 --set-mark 41001
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.149 -p udp --dport 53 --set-mark 41004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.149 -p udp --sport 53 --set-mark 41001
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.149 -p tcp --dport 80 --set-mark 41004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.149 -p tcp --sport 80 --set-mark 41001
iptables -t nat -A POSTROUTING -s 172.16.0.149 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Mariela Rossetti	IP:46    ID: 411
#------------------------------------------------------------------------------
iptables -X 172.16.0.46_i
iptables -X 172.16.0.46_o
iptables -N 172.16.0.46_i
iptables -N 172.16.0.46_o
iptables -F 172.16.0.46_i
iptables -F 172.16.0.46_o
iptables -A FORWARD -s 172.16.0.46 -j 172.16.0.46_o
iptables -A FORWARD -d 172.16.0.46 -j 172.16.0.46_i
iptables -A FORWARD -s 172.16.0.46 -m mac --mac-source 00:0b:82:14:dc:47 -j ACCEPT
iptables -A FORWARD -d 172.16.0.46 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4111 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:4111 classid 1:411a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:4111 classid 1:411b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 41101 fw classid 1:411a
tc filter add dev eth0 protocol ip parent 1: handle 41102 fw classid 1:411b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4110 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:4110 classid 1:411d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:4110 classid 1:411e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 41104 fw classid 1:411d
tc filter add dev eth1 protocol ip parent 1: handle 41105 fw classid 1:411e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.46 --set-mark 41102
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.46 --set-mark 41105

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.46 -p tcp --dport 22 --set-mark 41104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.46 -p tcp --sport 22 --set-mark 41101
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.46 -p udp --dport 53 --set-mark 41104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.46 -p udp --sport 53 --set-mark 41101
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.46 -p tcp --dport 80 --set-mark 41104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.46 -p tcp --sport 80 --set-mark 41101
iptables -t nat -A POSTROUTING -s 172.16.0.46 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Telefono IP Panasonic	IP:153    ID: 415
#------------------------------------------------------------------------------
iptables -X 172.16.0.153_i
iptables -X 172.16.0.153_o
iptables -N 172.16.0.153_i
iptables -N 172.16.0.153_o
iptables -F 172.16.0.153_i
iptables -F 172.16.0.153_o
iptables -A FORWARD -s 172.16.0.153 -j 172.16.0.153_o
iptables -A FORWARD -d 172.16.0.153 -j 172.16.0.153_i
iptables -A FORWARD -s 172.16.0.153 -m mac --mac-source 00:80:f0:d1:d1:dd -j ACCEPT
iptables -A FORWARD -d 172.16.0.153 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4151 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:4151 classid 1:415a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:4151 classid 1:415b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 41501 fw classid 1:415a
tc filter add dev eth0 protocol ip parent 1: handle 41502 fw classid 1:415b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4150 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:4150 classid 1:415d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:4150 classid 1:415e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 41504 fw classid 1:415d
tc filter add dev eth1 protocol ip parent 1: handle 41505 fw classid 1:415e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.153 --set-mark 41502
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.153 --set-mark 41505

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.153 -p tcp --dport 22 --set-mark 41504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.153 -p tcp --sport 22 --set-mark 41501
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.153 -p udp --dport 53 --set-mark 41504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.153 -p udp --sport 53 --set-mark 41501
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.153 -p tcp --dport 80 --set-mark 41504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.153 -p tcp --sport 80 --set-mark 41501
iptables -t nat -A POSTROUTING -s 172.16.0.153 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Impresora Onell	IP:31    ID: 417
#------------------------------------------------------------------------------
iptables -X 172.16.0.31_i
iptables -X 172.16.0.31_o
iptables -N 172.16.0.31_i
iptables -N 172.16.0.31_o
iptables -F 172.16.0.31_i
iptables -F 172.16.0.31_o
iptables -A FORWARD -s 172.16.0.31 -j 172.16.0.31_o
iptables -A FORWARD -d 172.16.0.31 -j 172.16.0.31_i
iptables -A FORWARD -s 172.16.0.31 -m mac --mac-source 00:15:99:ac:98:99 -j ACCEPT
iptables -A FORWARD -d 172.16.0.31 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4171 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:4171 classid 1:417a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:4171 classid 1:417b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 41701 fw classid 1:417a
tc filter add dev eth0 protocol ip parent 1: handle 41702 fw classid 1:417b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4170 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:4170 classid 1:417d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:4170 classid 1:417e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 41704 fw classid 1:417d
tc filter add dev eth1 protocol ip parent 1: handle 41705 fw classid 1:417e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.31 --set-mark 41702
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.31 --set-mark 41705

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.31 -p tcp --dport 22 --set-mark 41704
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.31 -p tcp --sport 22 --set-mark 41701
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.31 -p udp --dport 53 --set-mark 41704
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.31 -p udp --sport 53 --set-mark 41701
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.31 -p tcp --dport 80 --set-mark 41704
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.31 -p tcp --sport 80 --set-mark 41701
iptables -t nat -A POSTROUTING -s 172.16.0.31 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Alejandro Rogers	IP:29    ID: 418
#------------------------------------------------------------------------------
iptables -X 172.16.0.29_i
iptables -X 172.16.0.29_o
iptables -N 172.16.0.29_i
iptables -N 172.16.0.29_o
iptables -F 172.16.0.29_i
iptables -F 172.16.0.29_o
iptables -A FORWARD -s 172.16.0.29 -j 172.16.0.29_o
iptables -A FORWARD -d 172.16.0.29 -j 172.16.0.29_i
iptables -A FORWARD -s 172.16.0.29 -m mac --mac-source 94:39:e5:0e:73:15 -j ACCEPT
iptables -A FORWARD -d 172.16.0.29 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4181 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:4181 classid 1:418a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:4181 classid 1:418b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 41801 fw classid 1:418a
tc filter add dev eth0 protocol ip parent 1: handle 41802 fw classid 1:418b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4180 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:4180 classid 1:418d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:4180 classid 1:418e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 41804 fw classid 1:418d
tc filter add dev eth1 protocol ip parent 1: handle 41805 fw classid 1:418e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.29 --set-mark 41802
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.29 --set-mark 41805

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.29 -p tcp --dport 22 --set-mark 41804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.29 -p tcp --sport 22 --set-mark 41801
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.29 -p udp --dport 53 --set-mark 41804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.29 -p udp --sport 53 --set-mark 41801
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.29 -p tcp --dport 80 --set-mark 41804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.29 -p tcp --sport 80 --set-mark 41801
iptables -t nat -A POSTROUTING -s 172.16.0.29 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Onell Lanfranco	IP:37    ID: 422
#------------------------------------------------------------------------------
iptables -X 172.16.0.37_i
iptables -X 172.16.0.37_o
iptables -N 172.16.0.37_i
iptables -N 172.16.0.37_o
iptables -F 172.16.0.37_i
iptables -F 172.16.0.37_o
iptables -A FORWARD -s 172.16.0.37 -j 172.16.0.37_o
iptables -A FORWARD -d 172.16.0.37 -j 172.16.0.37_i
iptables -A FORWARD -s 172.16.0.37 -m mac --mac-source c8:6f:1d:0b:3e:66 -j ACCEPT
iptables -A FORWARD -d 172.16.0.37 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4221 htb rate 2048kbit ceil 2048kbit burst 15k
tc class add dev eth0 parent 1:4221 classid 1:422a htb rate 819kbit ceil 2048kbit burst 15k prio 0
tc class add dev eth0 parent 1:4221 classid 1:422b htb rate 819kbit ceil 2048kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 42201 fw classid 1:422a
tc filter add dev eth0 protocol ip parent 1: handle 42202 fw classid 1:422b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4220 htb rate 2048kbit ceil 2048kbit burst 15k
tc class add dev eth1 parent 1:4220 classid 1:422d htb rate 819kbit ceil 2048kbit burst 15k prio 0
tc class add dev eth1 parent 1:4220 classid 1:422e htb rate 819kbit ceil 2048kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 42204 fw classid 1:422d
tc filter add dev eth1 protocol ip parent 1: handle 42205 fw classid 1:422e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.37 --set-mark 42202
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.37 --set-mark 42205

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.37 -p tcp --dport 22 --set-mark 42204
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.37 -p tcp --sport 22 --set-mark 42201
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.37 -p udp --dport 53 --set-mark 42204
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.37 -p udp --sport 53 --set-mark 42201
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.37 -p tcp --dport 80 --set-mark 42204
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.37 -p tcp --sport 80 --set-mark 42201
iptables -t nat -A POSTROUTING -s 172.16.0.37 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Jose Lopez	IP:50    ID: 423
#------------------------------------------------------------------------------
iptables -X 172.16.0.50_i
iptables -X 172.16.0.50_o
iptables -N 172.16.0.50_i
iptables -N 172.16.0.50_o
iptables -F 172.16.0.50_i
iptables -F 172.16.0.50_o
iptables -A FORWARD -s 172.16.0.50 -j 172.16.0.50_o
iptables -A FORWARD -d 172.16.0.50 -j 172.16.0.50_i
iptables -A FORWARD -s 172.16.0.50 -m mac --mac-source 9c:04:eb:e9:b5:3a -j ACCEPT
iptables -A FORWARD -d 172.16.0.50 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4231 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:4231 classid 1:423a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:4231 classid 1:423b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 42301 fw classid 1:423a
tc filter add dev eth0 protocol ip parent 1: handle 42302 fw classid 1:423b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4230 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:4230 classid 1:423d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:4230 classid 1:423e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 42304 fw classid 1:423d
tc filter add dev eth1 protocol ip parent 1: handle 42305 fw classid 1:423e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.50 --set-mark 42302
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.50 --set-mark 42305

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.50 -p tcp --dport 22 --set-mark 42304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.50 -p tcp --sport 22 --set-mark 42301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.50 -p udp --dport 53 --set-mark 42304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.50 -p udp --sport 53 --set-mark 42301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.50 -p tcp --dport 80 --set-mark 42304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.50 -p tcp --sport 80 --set-mark 42301
iptables -t nat -A POSTROUTING -s 172.16.0.50 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Onell Lanfranco	IP:52    ID: 433
#------------------------------------------------------------------------------
iptables -X 172.16.0.52_i
iptables -X 172.16.0.52_o
iptables -N 172.16.0.52_i
iptables -N 172.16.0.52_o
iptables -F 172.16.0.52_i
iptables -F 172.16.0.52_o
iptables -A FORWARD -s 172.16.0.52 -j 172.16.0.52_o
iptables -A FORWARD -d 172.16.0.52 -j 172.16.0.52_i
iptables -A FORWARD -s 172.16.0.52 -m mac --mac-source 10:dd:b1:aa:09:3a -j ACCEPT
iptables -A FORWARD -d 172.16.0.52 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4331 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:4331 classid 1:433a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:4331 classid 1:433b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 43301 fw classid 1:433a
tc filter add dev eth0 protocol ip parent 1: handle 43302 fw classid 1:433b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4330 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:4330 classid 1:433d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:4330 classid 1:433e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 43304 fw classid 1:433d
tc filter add dev eth1 protocol ip parent 1: handle 43305 fw classid 1:433e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.52 --set-mark 43302
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.52 --set-mark 43305

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.52 -p tcp --dport 22 --set-mark 43304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.52 -p tcp --sport 22 --set-mark 43301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.52 -p udp --dport 53 --set-mark 43304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.52 -p udp --sport 53 --set-mark 43301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.52 -p tcp --dport 80 --set-mark 43304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.52 -p tcp --sport 80 --set-mark 43301
iptables -t nat -A POSTROUTING -s 172.16.0.52 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Sonia Toconas	IP:54    ID: 434
#------------------------------------------------------------------------------
iptables -X 172.16.0.54_i
iptables -X 172.16.0.54_o
iptables -N 172.16.0.54_i
iptables -N 172.16.0.54_o
iptables -F 172.16.0.54_i
iptables -F 172.16.0.54_o
iptables -A FORWARD -s 172.16.0.54 -j 172.16.0.54_o
iptables -A FORWARD -d 172.16.0.54 -j 172.16.0.54_i
iptables -A FORWARD -s 172.16.0.54 -m mac --mac-source b8:03:05:4e:e1:43 -j ACCEPT
iptables -A FORWARD -d 172.16.0.54 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4341 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:4341 classid 1:434a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:4341 classid 1:434b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 43401 fw classid 1:434a
tc filter add dev eth0 protocol ip parent 1: handle 43402 fw classid 1:434b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4340 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:4340 classid 1:434d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:4340 classid 1:434e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 43404 fw classid 1:434d
tc filter add dev eth1 protocol ip parent 1: handle 43405 fw classid 1:434e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.54 --set-mark 43402
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.54 --set-mark 43405

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.54 -p tcp --dport 22 --set-mark 43404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.54 -p tcp --sport 22 --set-mark 43401
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.54 -p udp --dport 53 --set-mark 43404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.54 -p udp --sport 53 --set-mark 43401
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.54 -p tcp --dport 80 --set-mark 43404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.54 -p tcp --sport 80 --set-mark 43401
iptables -t nat -A POSTROUTING -s 172.16.0.54 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC49	IP:124    ID: 435
#------------------------------------------------------------------------------
iptables -X 172.16.0.124_i
iptables -X 172.16.0.124_o
iptables -N 172.16.0.124_i
iptables -N 172.16.0.124_o
iptables -F 172.16.0.124_i
iptables -F 172.16.0.124_o
iptables -A FORWARD -s 172.16.0.124 -j 172.16.0.124_o
iptables -A FORWARD -d 172.16.0.124 -j 172.16.0.124_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4351 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:4351 classid 1:435a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:4351 classid 1:435b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 43501 fw classid 1:435a
tc filter add dev eth0 protocol ip parent 1: handle 43502 fw classid 1:435b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4350 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:4350 classid 1:435d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:4350 classid 1:435e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 43504 fw classid 1:435d
tc filter add dev eth1 protocol ip parent 1: handle 43505 fw classid 1:435e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.124 --set-mark 43502
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.124 --set-mark 43505

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.124 -p tcp --dport 22 --set-mark 43504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.124 -p tcp --sport 22 --set-mark 43501
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.124 -p udp --dport 53 --set-mark 43504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.124 -p udp --sport 53 --set-mark 43501
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.124 -p tcp --dport 80 --set-mark 43504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.124 -p tcp --sport 80 --set-mark 43501
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.124 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.124 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Depilight TV	IP:16    ID: 438
#------------------------------------------------------------------------------
iptables -X 172.16.0.16_i
iptables -X 172.16.0.16_o
iptables -N 172.16.0.16_i
iptables -N 172.16.0.16_o
iptables -F 172.16.0.16_i
iptables -F 172.16.0.16_o
iptables -A FORWARD -s 172.16.0.16 -j 172.16.0.16_o
iptables -A FORWARD -d 172.16.0.16 -j 172.16.0.16_i
iptables -A FORWARD -s 172.16.0.16 -m mac --mac-source 00:0b:6a:bf:79:58 -j ACCEPT
iptables -A FORWARD -d 172.16.0.16 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4381 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:4381 classid 1:438a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:4381 classid 1:438b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 43801 fw classid 1:438a
tc filter add dev eth0 protocol ip parent 1: handle 43802 fw classid 1:438b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4380 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:4380 classid 1:438d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:4380 classid 1:438e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 43804 fw classid 1:438d
tc filter add dev eth1 protocol ip parent 1: handle 43805 fw classid 1:438e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.16 --set-mark 43802
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.16 --set-mark 43805

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.16 -p tcp --dport 22 --set-mark 43804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.16 -p tcp --sport 22 --set-mark 43801
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.16 -p udp --dport 53 --set-mark 43804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.16 -p udp --sport 53 --set-mark 43801
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.16 -p tcp --dport 80 --set-mark 43804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.16 -p tcp --sport 80 --set-mark 43801
iptables -t nat -A POSTROUTING -s 172.16.0.16 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Notebook C. Mattiussi	IP:17    ID: 444
#------------------------------------------------------------------------------
iptables -X 172.16.0.17_i
iptables -X 172.16.0.17_o
iptables -N 172.16.0.17_i
iptables -N 172.16.0.17_o
iptables -F 172.16.0.17_i
iptables -F 172.16.0.17_o
iptables -A FORWARD -s 172.16.0.17 -j 172.16.0.17_o
iptables -A FORWARD -d 172.16.0.17 -j 172.16.0.17_i
iptables -A FORWARD -s 172.16.0.17 -m mac --mac-source 00:22:fa:2d:c8:a6 -j ACCEPT
iptables -A FORWARD -d 172.16.0.17 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4441 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:4441 classid 1:444a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:4441 classid 1:444b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 44401 fw classid 1:444a
tc filter add dev eth0 protocol ip parent 1: handle 44402 fw classid 1:444b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4440 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:4440 classid 1:444d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:4440 classid 1:444e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 44404 fw classid 1:444d
tc filter add dev eth1 protocol ip parent 1: handle 44405 fw classid 1:444e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.17 --set-mark 44402
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.17 --set-mark 44405

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.17 -p tcp --dport 22 --set-mark 44404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.17 -p tcp --sport 22 --set-mark 44401
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.17 -p udp --dport 53 --set-mark 44404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.17 -p udp --sport 53 --set-mark 44401
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.17 -p tcp --dport 80 --set-mark 44404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.17 -p tcp --sport 80 --set-mark 44401
iptables -t nat -A POSTROUTING -s 172.16.0.17 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Notebook D. Juarez	IP:60    ID: 445
#------------------------------------------------------------------------------
iptables -X 172.16.0.60_i
iptables -X 172.16.0.60_o
iptables -N 172.16.0.60_i
iptables -N 172.16.0.60_o
iptables -F 172.16.0.60_i
iptables -F 172.16.0.60_o
iptables -A FORWARD -s 172.16.0.60 -j 172.16.0.60_o
iptables -A FORWARD -d 172.16.0.60 -j 172.16.0.60_i
iptables -A FORWARD -s 172.16.0.60 -m mac --mac-source 00:26:c6:c6:7e:c4 -j ACCEPT
iptables -A FORWARD -d 172.16.0.60 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4451 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:4451 classid 1:445a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:4451 classid 1:445b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 44501 fw classid 1:445a
tc filter add dev eth0 protocol ip parent 1: handle 44502 fw classid 1:445b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4450 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:4450 classid 1:445d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:4450 classid 1:445e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 44504 fw classid 1:445d
tc filter add dev eth1 protocol ip parent 1: handle 44505 fw classid 1:445e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.60 --set-mark 44502
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.60 --set-mark 44505

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.60 -p tcp --dport 22 --set-mark 44504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.60 -p tcp --sport 22 --set-mark 44501
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.60 -p udp --dport 53 --set-mark 44504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.60 -p udp --sport 53 --set-mark 44501
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.60 -p tcp --dport 80 --set-mark 44504
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.60 -p tcp --sport 80 --set-mark 44501
iptables -t nat -A POSTROUTING -s 172.16.0.60 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Notebook D. Juarez	IP:20    ID: 447
#------------------------------------------------------------------------------
iptables -X 172.16.0.20_i
iptables -X 172.16.0.20_o
iptables -N 172.16.0.20_i
iptables -N 172.16.0.20_o
iptables -F 172.16.0.20_i
iptables -F 172.16.0.20_o
iptables -A FORWARD -s 172.16.0.20 -j 172.16.0.20_o
iptables -A FORWARD -d 172.16.0.20 -j 172.16.0.20_i
iptables -A FORWARD -s 172.16.0.20 -m mac --mac-source 00:22:68:19:c9:96 -j ACCEPT
iptables -A FORWARD -d 172.16.0.20 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4471 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:4471 classid 1:447a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:4471 classid 1:447b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 44701 fw classid 1:447a
tc filter add dev eth0 protocol ip parent 1: handle 44702 fw classid 1:447b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4470 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:4470 classid 1:447d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:4470 classid 1:447e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 44704 fw classid 1:447d
tc filter add dev eth1 protocol ip parent 1: handle 44705 fw classid 1:447e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.20 --set-mark 44702
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.20 --set-mark 44705

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.20 -p tcp --dport 22 --set-mark 44704
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.20 -p tcp --sport 22 --set-mark 44701
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.20 -p udp --dport 53 --set-mark 44704
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.20 -p udp --sport 53 --set-mark 44701
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.20 -p tcp --dport 80 --set-mark 44704
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.20 -p tcp --sport 80 --set-mark 44701
iptables -t nat -A POSTROUTING -s 172.16.0.20 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Claudia Mattiussi 	IP:25    ID: 451
#------------------------------------------------------------------------------
iptables -X 172.16.0.25_i
iptables -X 172.16.0.25_o
iptables -N 172.16.0.25_i
iptables -N 172.16.0.25_o
iptables -F 172.16.0.25_i
iptables -F 172.16.0.25_o
iptables -A FORWARD -s 172.16.0.25 -j 172.16.0.25_o
iptables -A FORWARD -d 172.16.0.25 -j 172.16.0.25_i
iptables -A FORWARD -s 172.16.0.25 -m mac --mac-source 00:1c:25:9f:e2:82 -j ACCEPT
iptables -A FORWARD -d 172.16.0.25 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4511 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:4511 classid 1:451a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:4511 classid 1:451b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 45101 fw classid 1:451a
tc filter add dev eth0 protocol ip parent 1: handle 45102 fw classid 1:451b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4510 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:4510 classid 1:451d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:4510 classid 1:451e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 45104 fw classid 1:451d
tc filter add dev eth1 protocol ip parent 1: handle 45105 fw classid 1:451e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.25 --set-mark 45102
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.25 --set-mark 45105

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.25 -p tcp --dport 22 --set-mark 45104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.25 -p tcp --sport 22 --set-mark 45101
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.25 -p udp --dport 53 --set-mark 45104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.25 -p udp --sport 53 --set-mark 45101
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.25 -p tcp --dport 80 --set-mark 45104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.25 -p tcp --sport 80 --set-mark 45101
iptables -t nat -A POSTROUTING -s 172.16.0.25 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Toshiba Satellite	IP:51    ID: 452
#------------------------------------------------------------------------------
iptables -X 172.16.0.51_i
iptables -X 172.16.0.51_o
iptables -N 172.16.0.51_i
iptables -N 172.16.0.51_o
iptables -F 172.16.0.51_i
iptables -F 172.16.0.51_o
iptables -A FORWARD -s 172.16.0.51 -j 172.16.0.51_o
iptables -A FORWARD -d 172.16.0.51 -j 172.16.0.51_i
iptables -A FORWARD -s 172.16.0.51 -m mac --mac-source 00:26:9e:d9:f6:fc -j ACCEPT
iptables -A FORWARD -d 172.16.0.51 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4521 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:4521 classid 1:452a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:4521 classid 1:452b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 45201 fw classid 1:452a
tc filter add dev eth0 protocol ip parent 1: handle 45202 fw classid 1:452b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4520 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:4520 classid 1:452d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:4520 classid 1:452e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 45204 fw classid 1:452d
tc filter add dev eth1 protocol ip parent 1: handle 45205 fw classid 1:452e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.51 --set-mark 45202
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.51 --set-mark 45205

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.51 -p tcp --dport 22 --set-mark 45204
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.51 -p tcp --sport 22 --set-mark 45201
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.51 -p udp --dport 53 --set-mark 45204
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.51 -p udp --sport 53 --set-mark 45201
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.51 -p tcp --dport 80 --set-mark 45204
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.51 -p tcp --sport 80 --set-mark 45201
iptables -t nat -A POSTROUTING -s 172.16.0.51 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Jose Lopez	IP:11    ID: 453
#------------------------------------------------------------------------------
iptables -X 172.16.0.11_i
iptables -X 172.16.0.11_o
iptables -N 172.16.0.11_i
iptables -N 172.16.0.11_o
iptables -F 172.16.0.11_i
iptables -F 172.16.0.11_o
iptables -A FORWARD -s 172.16.0.11 -j 172.16.0.11_o
iptables -A FORWARD -d 172.16.0.11 -j 172.16.0.11_i
iptables -A FORWARD -s 172.16.0.11 -m mac --mac-source 40:6f:2a:da:1c:01 -j ACCEPT
iptables -A FORWARD -d 172.16.0.11 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4531 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:4531 classid 1:453a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:4531 classid 1:453b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 45301 fw classid 1:453a
tc filter add dev eth0 protocol ip parent 1: handle 45302 fw classid 1:453b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4530 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:4530 classid 1:453d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:4530 classid 1:453e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 45304 fw classid 1:453d
tc filter add dev eth1 protocol ip parent 1: handle 45305 fw classid 1:453e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.11 --set-mark 45302
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.11 --set-mark 45305

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.11 -p tcp --dport 22 --set-mark 45304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.11 -p tcp --sport 22 --set-mark 45301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.11 -p udp --dport 53 --set-mark 45304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.11 -p udp --sport 53 --set-mark 45301
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.11 -p tcp --dport 80 --set-mark 45304
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.11 -p tcp --sport 80 --set-mark 45301
iptables -t nat -A POSTROUTING -s 172.16.0.11 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Arogers	IP:15    ID: 454
#------------------------------------------------------------------------------
iptables -X 172.16.0.15_i
iptables -X 172.16.0.15_o
iptables -N 172.16.0.15_i
iptables -N 172.16.0.15_o
iptables -F 172.16.0.15_i
iptables -F 172.16.0.15_o
iptables -A FORWARD -s 172.16.0.15 -j 172.16.0.15_o
iptables -A FORWARD -d 172.16.0.15 -j 172.16.0.15_i
iptables -A FORWARD -s 172.16.0.15 -m mac --mac-source 00:1b:b9:e2:51:7e -j ACCEPT
iptables -A FORWARD -d 172.16.0.15 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4541 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:4541 classid 1:454a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:4541 classid 1:454b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 45401 fw classid 1:454a
tc filter add dev eth0 protocol ip parent 1: handle 45402 fw classid 1:454b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4540 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:4540 classid 1:454d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:4540 classid 1:454e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 45404 fw classid 1:454d
tc filter add dev eth1 protocol ip parent 1: handle 45405 fw classid 1:454e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.15 --set-mark 45402
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.15 --set-mark 45405

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.15 -p tcp --dport 22 --set-mark 45404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.15 -p tcp --sport 22 --set-mark 45401
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.15 -p udp --dport 53 --set-mark 45404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.15 -p udp --sport 53 --set-mark 45401
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.15 -p tcp --dport 80 --set-mark 45404
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.15 -p tcp --sport 80 --set-mark 45401
iptables -t nat -A POSTROUTING -s 172.16.0.15 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Djuarez 	IP:59    ID: 456
#------------------------------------------------------------------------------
iptables -X 172.16.0.59_i
iptables -X 172.16.0.59_o
iptables -N 172.16.0.59_i
iptables -N 172.16.0.59_o
iptables -F 172.16.0.59_i
iptables -F 172.16.0.59_o
iptables -A FORWARD -s 172.16.0.59 -j 172.16.0.59_o
iptables -A FORWARD -d 172.16.0.59 -j 172.16.0.59_i
iptables -A FORWARD -s 172.16.0.59 -m mac --mac-source 80:96:b1:df:d1:77 -j ACCEPT
iptables -A FORWARD -d 172.16.0.59 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4561 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:4561 classid 1:456a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:4561 classid 1:456b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 45601 fw classid 1:456a
tc filter add dev eth0 protocol ip parent 1: handle 45602 fw classid 1:456b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4560 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:4560 classid 1:456d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:4560 classid 1:456e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 45604 fw classid 1:456d
tc filter add dev eth1 protocol ip parent 1: handle 45605 fw classid 1:456e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.59 --set-mark 45602
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.59 --set-mark 45605

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.59 -p tcp --dport 22 --set-mark 45604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.59 -p tcp --sport 22 --set-mark 45601
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.59 -p udp --dport 53 --set-mark 45604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.59 -p udp --sport 53 --set-mark 45601
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.59 -p tcp --dport 80 --set-mark 45604
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.59 -p tcp --sport 80 --set-mark 45601
iptables -t nat -A POSTROUTING -s 172.16.0.59 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Desktop XUBUNTU	IP:19    ID: 457
#------------------------------------------------------------------------------
iptables -X 172.16.0.19_i
iptables -X 172.16.0.19_o
iptables -N 172.16.0.19_i
iptables -N 172.16.0.19_o
iptables -F 172.16.0.19_i
iptables -F 172.16.0.19_o
iptables -A FORWARD -s 172.16.0.19 -j 172.16.0.19_o
iptables -A FORWARD -d 172.16.0.19 -j 172.16.0.19_i
iptables -A FORWARD -s 172.16.0.19 -m mac --mac-source 00:0b:6a:bf:a7:70 -j ACCEPT
iptables -A FORWARD -d 172.16.0.19 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4571 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:4571 classid 1:457a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:4571 classid 1:457b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 45701 fw classid 1:457a
tc filter add dev eth0 protocol ip parent 1: handle 45702 fw classid 1:457b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4570 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:4570 classid 1:457d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:4570 classid 1:457e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 45704 fw classid 1:457d
tc filter add dev eth1 protocol ip parent 1: handle 45705 fw classid 1:457e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.19 --set-mark 45702
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.19 --set-mark 45705

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.19 -p tcp --dport 22 --set-mark 45704
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.19 -p tcp --sport 22 --set-mark 45701
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.19 -p udp --dport 53 --set-mark 45704
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.19 -p udp --sport 53 --set-mark 45701
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.19 -p tcp --dport 80 --set-mark 45704
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.19 -p tcp --sport 80 --set-mark 45701
iptables -t nat -A POSTROUTING -s 172.16.0.19 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Arogers	IP:27    ID: 458
#------------------------------------------------------------------------------
iptables -X 172.16.0.27_i
iptables -X 172.16.0.27_o
iptables -N 172.16.0.27_i
iptables -N 172.16.0.27_o
iptables -F 172.16.0.27_i
iptables -F 172.16.0.27_o
iptables -A FORWARD -s 172.16.0.27 -j 172.16.0.27_o
iptables -A FORWARD -d 172.16.0.27 -j 172.16.0.27_i
iptables -A FORWARD -s 172.16.0.27 -m mac --mac-source bc:3b:af:c3:21:0e -j ACCEPT
iptables -A FORWARD -d 172.16.0.27 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4581 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:4581 classid 1:458a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:4581 classid 1:458b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 45801 fw classid 1:458a
tc filter add dev eth0 protocol ip parent 1: handle 45802 fw classid 1:458b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4580 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:4580 classid 1:458d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:4580 classid 1:458e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 45804 fw classid 1:458d
tc filter add dev eth1 protocol ip parent 1: handle 45805 fw classid 1:458e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.27 --set-mark 45802
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.27 --set-mark 45805

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.27 -p tcp --dport 22 --set-mark 45804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.27 -p tcp --sport 22 --set-mark 45801
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.27 -p udp --dport 53 --set-mark 45804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.27 -p udp --sport 53 --set-mark 45801
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.27 -p tcp --dport 80 --set-mark 45804
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.27 -p tcp --sport 80 --set-mark 45801
iptables -t nat -A POSTROUTING -s 172.16.0.27 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC53	IP:21    ID: 459
#------------------------------------------------------------------------------
iptables -X 172.16.0.21_i
iptables -X 172.16.0.21_o
iptables -N 172.16.0.21_i
iptables -N 172.16.0.21_o
iptables -F 172.16.0.21_i
iptables -F 172.16.0.21_o
iptables -A FORWARD -s 172.16.0.21 -j 172.16.0.21_o
iptables -A FORWARD -d 172.16.0.21 -j 172.16.0.21_i
iptables -A FORWARD -s 172.16.0.21 -m mac --mac-source 00:0b:6a:c6:5e:6f -j ACCEPT
iptables -A FORWARD -d 172.16.0.21 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4591 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:4591 classid 1:459a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:4591 classid 1:459b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 45901 fw classid 1:459a
tc filter add dev eth0 protocol ip parent 1: handle 45902 fw classid 1:459b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4590 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:4590 classid 1:459d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:4590 classid 1:459e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 45904 fw classid 1:459d
tc filter add dev eth1 protocol ip parent 1: handle 45905 fw classid 1:459e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.21 --set-mark 45902
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.21 --set-mark 45905

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.21 -p tcp --dport 22 --set-mark 45904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.21 -p tcp --sport 22 --set-mark 45901
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.21 -p udp --dport 53 --set-mark 45904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.21 -p udp --sport 53 --set-mark 45901
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.21 -p tcp --dport 80 --set-mark 45904
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.21 -p tcp --sport 80 --set-mark 45901
iptables -t nat -A POSTROUTING -s 172.16.0.21 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - PC54	IP:154    ID: 460
#------------------------------------------------------------------------------
iptables -X 172.16.0.154_i
iptables -X 172.16.0.154_o
iptables -N 172.16.0.154_i
iptables -N 172.16.0.154_o
iptables -F 172.16.0.154_i
iptables -F 172.16.0.154_o
iptables -A FORWARD -s 172.16.0.154 -j 172.16.0.154_o
iptables -A FORWARD -d 172.16.0.154 -j 172.16.0.154_i

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4601 htb rate 480kbit ceil 480kbit burst 15k
tc class add dev eth0 parent 1:4601 classid 1:460a htb rate 192kbit ceil 480kbit burst 15k prio 0
tc class add dev eth0 parent 1:4601 classid 1:460b htb rate 192kbit ceil 480kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 46001 fw classid 1:460a
tc filter add dev eth0 protocol ip parent 1: handle 46002 fw classid 1:460b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4600 htb rate 160kbit ceil 160kbit burst 15k
tc class add dev eth1 parent 1:4600 classid 1:460d htb rate 64kbit ceil 160kbit burst 15k prio 0
tc class add dev eth1 parent 1:4600 classid 1:460e htb rate 64kbit ceil 160kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 46004 fw classid 1:460d
tc filter add dev eth1 protocol ip parent 1: handle 46005 fw classid 1:460e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.154 --set-mark 46002
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.154 --set-mark 46005

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.154 -p tcp --dport 22 --set-mark 46004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.154 -p tcp --sport 22 --set-mark 46001
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.154 -p udp --dport 53 --set-mark 46004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.154 -p udp --sport 53 --set-mark 46001
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.154 -p tcp --dport 80 --set-mark 46004
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.154 -p tcp --sport 80 --set-mark 46001
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -s 172.16.0.154 -j REDIRECT --to-port 3128
iptables -t nat -A POSTROUTING -s 172.16.0.154 -o eth1 -j MASQUERADE


#------------------------------------------------------------------------------
#Cliente - Onell Lanfranco	IP:249    ID: 461
#------------------------------------------------------------------------------
iptables -X 172.16.0.249_i
iptables -X 172.16.0.249_o
iptables -N 172.16.0.249_i
iptables -N 172.16.0.249_o
iptables -F 172.16.0.249_i
iptables -F 172.16.0.249_o
iptables -A FORWARD -s 172.16.0.249 -j 172.16.0.249_o
iptables -A FORWARD -d 172.16.0.249 -j 172.16.0.249_i
iptables -A FORWARD -s 172.16.0.249 -m mac --mac-source f4:f9:51:c8:db:ed -j ACCEPT
iptables -A FORWARD -d 172.16.0.249 -j ACCEPT

# CLASES DE BAJADA
tc class add dev eth0 parent 1: classid 1:4611 htb rate 960kbit ceil 960kbit burst 15k
tc class add dev eth0 parent 1:4611 classid 1:461a htb rate 384kbit ceil 960kbit burst 15k prio 0
tc class add dev eth0 parent 1:4611 classid 1:461b htb rate 384kbit ceil 960kbit burst 15k prio 1
tc filter add dev eth0 protocol ip parent 1: handle 46101 fw classid 1:461a
tc filter add dev eth0 protocol ip parent 1: handle 46102 fw classid 1:461b


# CLASES DE SUBIDA
tc class add dev eth1 parent 1: classid 1:4610 htb rate 320kbit ceil 320kbit burst 15k
tc class add dev eth1 parent 1:4610 classid 1:461d htb rate 128kbit ceil 320kbit burst 15k prio 0
tc class add dev eth1 parent 1:4610 classid 1:461e htb rate 128kbit ceil 320kbit burst 15k prio 1
tc filter add dev eth1 protocol ip parent 1: handle 46104 fw classid 1:461d
tc filter add dev eth1 protocol ip parent 1: handle 46105 fw classid 1:461e


# MARCAJE DE PAQUETES

iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.249 --set-mark 46102
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.249 --set-mark 46105

iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.249 -p tcp --dport 22 --set-mark 46104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.249 -p tcp --sport 22 --set-mark 46101
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.249 -p udp --dport 53 --set-mark 46104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.249 -p udp --sport 53 --set-mark 46101
iptables -t mangle -A FORWARD -j MARK -i eth0 -s 172.16.0.249 -p tcp --dport 80 --set-mark 46104
iptables -t mangle -A FORWARD -j MARK -i eth1 -d 172.16.0.249 -p tcp --sport 80 --set-mark 46101
iptables -t nat -A POSTROUTING -s 172.16.0.249 -o eth1 -j MASQUERADE
iptables -A INPUT -p udp --dport 9010 -j ACCEPT
iptables -A OUTPUT -p udp --sport 9010 -j ACCEPT
iptables -A INPUT -p udp --dport 9010 -j ACCEPT
iptables -A OUTPUT -p udp --sport 9010 -j ACCEPT
iptables -t mangle -A PREROUTING -p tcp -j RETURN
iptables -P INPUT DROP
iptables -P OUTPUT DROP
iptables -P FORWARD DROP
iptables -t nat -A PREROUTING -i eth1 -p tcp -s 0.0.0.0/0 --dport 4097 -j DNAT --to 172.16.0.36:4097
